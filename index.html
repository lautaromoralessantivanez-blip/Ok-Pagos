<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OK Eventos ‚Äî Cloud</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
:root{ --bg:#F5F4F0; --card:#fff; --text:#222629; --muted:#6B7280; --gold-1:#F2D15F; --gold-2:#CFA33C; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,Arial,sans-serif}
.wrap{max-width:1240px;margin:22px auto;padding:16px}
header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
header img{width:68px;height:68px;border-radius:12px;object-fit:cover}
h1{font-size:20px;margin:0}
.small{font-size:13px;color:var(--muted)}
.card{background:var(--card);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:14px}
input,select,button{font-family:inherit}
input[type="text"],input[type="date"],input[type="number"],input[type="url"],input[type="email"],input[type="password"],select{width:100%;padding:10px;border:1px solid #e9e9e9;border-radius:8px;margin:6px 0 10px;background:#fff}
button{ color:#111;border:none;border-radius:10px;padding:10px 12px;cursor:pointer;
  background-image:linear-gradient(180deg,var(--gold-1),var(--gold-2));
  box-shadow:0 1px 0 rgba(0,0,0,.05), inset 0 .5px rgba(255,255,255,.6);
}
button:hover{filter:saturate(1.05) brightness(1.02)}
button[disabled]{opacity:.6;cursor:not-allowed}
button.ghost{background:#eee;color:#333;box-shadow:none}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 340px}
.list{max-height:340px;overflow:auto;border:1px dashed #eee;border-radius:10px;padding:8px}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px dashed #f0f0f0}
.inline{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.total{font-weight:700}
.qty{width:84px} .price{width:120px}
.tabs{display:flex;gap:6px;border-bottom:2px solid #e8e8e8;margin:10px 0 14px}
.tab{padding:10px 12px;border-radius:10px 10px 0 0;background:#ecebe6;cursor:pointer;font-weight:600}
.tab.active{background:#fff;border:1px solid #e8e8e8;border-bottom:none}
.tabpanel{display:none} .tabpanel.active{display:block}
.drop{border:2px dashed #cfcfcf;border-radius:12px;padding:16px;text-align:center;background:#fff}
.drop.drag{border-color:var(--gold-2);background:#fff8e6}
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.media{border:1px solid #eee;border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px;align-items:center}
.media img{max-width:100%;max-height:90px;object-fit:cover;border-radius:8px}
.link{color:#0b66ff;text-decoration:underline;cursor:pointer;font-size:13px}
.badge{font-size:11px;border:1px solid #e9e9e9;border-radius:999px;padding:2px 8px;margin-left:6px;background:#fafafa}

/* Panel / modal */
#evPanelBk{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-start;justify-content:center;z-index:60}
#evPanel{background:#fff;border-radius:14px;margin-top:24px;padding:16px;max-width:1100px;width:95%;max-height:88vh;overflow:auto}
.panelHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.close{background:#efefef;color:#222}
.err{color:#b00020;font-weight:600}

/* Subtabs provincia */
.subtabs{display:flex;gap:8px;margin:8px 0 6px}
.subtabs .chip{padding:6px 10px;border-radius:999px;border:1px solid #e8e8e8;background:#f7f7f5;cursor:pointer;font-weight:600}
.subtabs .chip.active{background:#fff;border-color:#d9d9d9;box-shadow:0 1px 0 rgba(0,0,0,.04)}

/* AUTH overlay */
#authBk{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:80}
#authCard{background:#fff;border-radius:16px;padding:18px;max-width:480px;width:92%}
.auth-tabs{display:flex;gap:6px;margin-bottom:10px}
.auth-tabs .chip.active{background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img id="logoPreview" src="https://placehold.co/300x300/ffffff/333333?text=OK+EVENTOS" alt="Logo" />
    <div style="flex:1">
      <h1>OK Eventos ‚Äî Cloud</h1>
      <div class="small" id="saveMode">Modo invitado (local)</div>
      <div class="inline">
        <input type="file" id="logoFile" accept="image/*" />
        <button class="ghost" id="logoGuardar" type="button">Guardar logo</button>
        <span class="small" id="logoStatus">Logo temporal</span>
        <span class="small" style="margin-left:auto">Cuenta: <b id="who">‚Äî</b></span>
        <button class="ghost" id="btnAuth">Iniciar sesi√≥n</button>
        <button class="ghost" id="btnLogout" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="evNew">Eventos</div>
    <div class="tab" data-tab="ex">Cat√°logo de Extras</div>
    <div class="tab" data-tab="evList">Eventos creados</div>
  </div>

  <!-- ===== Crear evento ===== -->
  <div id="tab-evNew" class="tabpanel active">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Crear evento</h3>

          <form id="evForm" autocomplete="off">
            <label>Tipo de evento</label>
            <select id="evType">
              <option value="15 a√±os">Cumple de 15</option>
              <option value="18 a√±os">Cumple de 18</option>
              <option value="Casamiento">Casamiento</option>
              <option value="Fiesta de Egresados">Fiesta de egresados</option>
              <option value="Otro">Otro</option>
            </select>

            <label>Nombre / t√≠tulo <span class="err" id="errName"></span></label>
            <input required type="text" id="evName" placeholder="Ej: 15 de Estefy / Promo 2026" />

            <div class="row">
              <div class="col">
                <label>Fecha <span class="err" id="errDate"></span></label>
                <input type="date" id="evDate" />
              </div>
              <div class="col">
                <label>Provincia</label>
                <select id="evProvince">
                  <option>San Juan</option>
                  <option>Mendoza</option>
                </select>
              </div>
            </div>

            <label>Sal√≥n (opcional)</label>
            <input type="text" id="evSalon" placeholder="Ej: Sal√≥n Imperial / La Finca" />

            <label>Opci√≥n (paquete/plan del evento)</label>
            <input type="text" id="evOption" placeholder="Ej: Opci√≥n Dorada / Paquete Full" />

<div class="row">
  <div class="col">
    <label>Precio por persona (cena) (ADULTOS) <span class="err" id="errPrice"></span></label>
    <input required type="text" id="evPricePer" placeholder="Ej: 15000" inputmode="decimal" />
  </div>
  <div class="col">
    <label>Precio por persona (cena) (NI√ëOS) (opcional)</label>
    <input type="text" id="evPricePerKids" placeholder="Si queda vac√≠o = 50% de adultos" inputmode="decimal" />
  </div>
</div>

<div class="row">
  <div class="col">
    <label>Precio ‚Äúdespu√©s de cena‚Äù (adultos)</label>
    <input type="text" id="evPriceAfter" placeholder="Ej: 5000" inputmode="decimal" />
  </div>
  <div class="col">
    <label>Precio ‚Äúdespu√©s de cena‚Äù (ni√±os)</label>
    <input type="text" id="evPriceAfterKids" placeholder="Ej: 3000" inputmode="decimal" />
  </div>
</div>
            <div class="row">
              <div class="col">
                <label>Adultos a cena</label>
                <input required type="number" id="evAdultsDinner" min="0" value="100" inputmode="numeric" />
              </div>
              <div class="col">
                <label>Ni√±os a cena (50%)</label>
                <input type="number" id="evKidsDinner" min="0" value="0" inputmode="numeric" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Adultos despu√©s de cena</label>
                <input type="number" id="evAdultsAfter" min="0" value="0" inputmode="numeric" />
              </div>
              <div class="col">
                <label>Ni√±os despu√©s de cena</label>
                <input type="number" id="evKidsAfter" min="0" value="0" inputmode="numeric" />
              </div>
            </div>

            <div class="small" id="evBasePreview">Total base estimado: $ 0,00</div>
            <div class="inline" style="justify-content:flex-end;margin-top:8px">
              <button id="evCreate" type="submit">Crear evento</button>
            </div>
          </form>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Extras/Combos para el NUEVO evento</h3>
          <label>Elegir √≠tem</label>
          <select id="newExFor"><option value="">-- elegir extra o combo --</option></select>
          <div class="inline">
            <input type="number" id="newExQty" class="qty" min="1" value="1" />
            <input type="text" id="newExPrice" class="price" placeholder="Precio (opcional)" />
            <button id="newAddEx" type="button">Agregar</button>
          </div>
          <div class="small">Si pon√©s precio aqu√≠, reemplaza el del cat√°logo <b>solo</b> para este evento.</div>

          <h4 style="margin:10px 0 6px">√çtems</h4>
          <div id="newExList" class="list"></div>
          <div class="inline" style="justify-content:space-between;margin-top:8px">
            <div class="small">Total √≠tems: <span class="total" id="newExTotal">$ 0,00</span></div>
            <button class="ghost" id="newClear" type="button">Vaciar</button>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Resumen</h3>
<div class="small">
  Cena ‚Äî Adultos: <b id="prevAdultsDinner">0</b> ‚Ä¢ Ni√±os<span id="newKidsLbl"> (50%)</span>: <b id="prevKidsDinner">0</b>
</div>
          <div class="small">Despu√©s ‚Äî Adultos: <b id="prevAdultsAfter">0</b> ‚Ä¢ Ni√±os: <b id="prevKidsAfter">0</b></div>
          <div class="small">Base (todas personas): <b id="newSumBase">$ 0,00</b></div>
          <div class="small">Extras/Combos: <b id="newSumExtras">$ 0,00</b></div>
          <div class="small">TOTAL: <b id="newSumTotal" class="total">$ 0,00</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Cat√°logo ===== -->
  <div id="tab-ex" class="tabpanel">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Nuevo ‚Äî Extra o Combo</h3>
          <div class="inline" style="gap:10px">
            <div style="flex:1">
              <label>Tipo</label>
              <select id="exType">
                <option value="extra">Extra</option>
                <option value="combo">Combo</option>
              </select>
            </div>
            <div style="flex:2">
              <label>Nombre</label>
              <input type="text" id="exName" placeholder="Ej: Combo 1 / Candy Bar" />
            </div>
            <div style="flex:1">
              <label>Precio</label>
              <input type="text" id="exPrice" placeholder="Ej: 90000" inputmode="decimal" />
            </div>
          </div>
          <button id="exCreate" type="button">Guardar</button>
        </div>

        <div class="card">
          <h3 style="margin:0 0 6px">Archivos del √≠tem</h3>
          <label>Elegir √≠tem</label>
          <select id="exSelectFiles"><option value="">-- elegir extra o combo --</option></select>

          <div id="drop" class="drop" style="margin-top:6px">
            Arrastr√° y solt√° PNG/JPG/PDF (m√°x. ~900 KB c/u) o
            <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="margin-left:6px" />
          </div>
          <div class="inline" style="margin-top:6px">
            <button id="btnUpload" type="button" class="ghost">Subir seleccionados</button>
            <span class="small">Si pesan m√°s, peg√° un enlace:</span>
          </div>
          <div class="inline">
            <input type="url" id="exLink" placeholder="https://drive.google.com/..." />
            <button id="btnAddLink" type="button" class="ghost">Guardar enlace</button>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Cat√°logo</h3>
          <div id="exList" class="list"></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">Galer√≠a del √≠tem</h3>
          <div id="exMedia" class="media-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Eventos creados ===== -->
  <div id="tab-evList" class="tabpanel">
    <div class="card">
      <h3 style="margin:0 0 6px">Buscar evento</h3>
      <input type="text" id="evSearch" placeholder="Escrib√≠ el nombre...">

      <div class="subtabs">
        <div class="chip active" data-prov="San Juan">San Juan</div>
        <div class="chip" data-prov="Mendoza">Mendoza</div>
        <div class="chip" data-prov="Todos">Todos</div>
      </div>

      <div id="evList" class="list" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- ======== PANEL DE EVENTO (Abrir) ======== -->
<div id="evPanelBk">
  <div id="evPanel" class="card">
    <div class="panelHead">
      <div>
        <h2 id="pEvName" style="margin:0 0 4px">Evento</h2>
        <div id="pEvMeta" class="small">‚Äî</div>
      </div>
      <div class="inline">
        <button id="pUndo" class="ghost" disabled>Deshacer</button>
        <button id="pDelete" class="ghost">Eliminar evento</button>
        <button id="pClose" class="close">Cerrar</button>
      </div>
    </div>

    <div class="row">
      <!-- Extras del evento -->
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Extras/Combos del evento</h3>
          <label>Elegir √≠tem</label>
          <select id="exForEvent"><option value="">-- elegir extra o combo --</option></select>
          <div class="inline">
            <input type="number" id="exQty" class="qty" min="1" value="1" />
            <input type="text" id="exPriceOverride" class="price" placeholder="Precio (opcional)" />
            <button id="addExtraToEvent" type="button">Agregar</button>
          </div>

          <h4 style="margin:10px 0 6px">√çtems del evento</h4>
          <div id="evExtrasList" class="list"></div>
          <div class="inline" style="justify-content:space-between;margin-top:8px">
            <div class="small">Total extras/combos: <span class="total" id="evExtrasTotal">$ 0,00</span></div>
            <button class="ghost" id="evClearExtras" type="button">Vaciar</button>
          </div>
        </div>
      </div>

      <!-- Pagos -->
      <div class="col">
    <div class="card">
  <h3 style="margin:0 0 6px">Pagos</h3>

  <div class="inline" style="gap:10px">
    <input style="flex:1" id="payAmount" type="text" placeholder="Monto" inputmode="decimal">
    <select style="flex:1" id="payMethod">
      <option>Efectivo</option><option>Transferencia</option><option>Mercado Pago</option><option>Tarjeta</option><option>Otro</option>
    </select>
    <select style="flex:1" id="payTarget" title="A qu√© se destina este pago">
  <option value="general">General / Mixto</option>
  <option value="extras">Extras</option>
  <option value="opciones">Opciones (cena)</option>
  <option value="despues">Despu√©s de cena</option>
</select>

<!-- NUEVO SELECT -->
<select style="flex:1" id="payPerson" title="Qui√©n es">
  <option value="adulto">Adulto</option>
  <option value="nino">Ni√±o</option>
</select>
  </div>

  <div class="small" style="margin-top:6px"><b>Comprobante (obligatorio):</b></div>
  <div class="inline">
    <input id="payProof" type="file" accept="image/*,application/pdf">
    <button id="payUpload" type="button" class="ghost">Usar archivo</button>
  </div>
  <div class="inline">
    <input id="payProofLink" type="url" placeholder="o peg√° un enlace http/https">
    <button id="payUseLink" type="button" class="ghost">Usar enlace</button>
  </div>
  <div class="small" id="proofStatus">Sin comprobante</div>

  <div class="inline" style="justify-content:flex-end;margin-top:6px">
    <button id="paySave" type="button">Guardar pago</button>
  </div>

  <h4 style="margin:10px 0 6px">Pagos guardados</h4>
  <div id="payList" class="list"></div>

  <div class="inline" style="justify-content:space-between;margin-top:8px">
    <div class="small">Total abonado: <span class="total" id="payTotal">$ 0,00</span></div>
    <button id="btnGeneralReceipt" class="ghost" type="button">Recibo GENERAL (PDF)</button>
  </div>
</div>


    <!-- Resumen y ajustes -->
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Resumen</h3>
          <div class="small">Sal√≥n: <b id="sumSalon">‚Äî</b></div>
          <div class="small">Cena ‚Äî Adultos: <b id="sumAdultsDinner">0</b> ‚Ä¢ Ni√±os<span id="kidsLbl"> (50%)</span>: <b id="sumKidsDinner">0</b></div>
          <div class="small">Despu√©s ‚Äî Adultos: <b id="sumAdultsAfter">0</b> ‚Ä¢ Ni√±os: <b id="sumKidsAfter">0</b></div>
          <div class="small">Precio/Persona (cena): <b id="sumPricePer">$ 0,00</b></div>
          <div class="small">Precio ‚Äúdespu√©s‚Äù Adultos/Ni√±os: <b id="sumAfterPrices">$ 0,00 / $ 0,00</b></div>
          <div class="small">Extras: <b id="sumExtrasInline">$ 0,00</b></div>
          <div class="small">Base: <b id="sumBase">$ 0,00</b> ‚Äî Extras: <b id="sumExtras">$ 0,00</b></div>
          <div class="small">TOTAL: <b id="sumTotal" class="total">$ 0,00</b> ‚Äî Abonado: <b id="sumPaid">$ 0,00</b> ‚Äî SALDO: <b id="sumRemain" class="total">$ 0,00</b></div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Editar sal√≥n</h3>
          <div class="inline">
            <input id="editSalon" type="text" placeholder="Nombre del sal√≥n">
            <button id="saveSalon" type="button">Guardar</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 6px">Editar personas & precios ‚Äúdespu√©s de cena‚Äù</h3>
          <div class="inline" style="gap:10px">
            <input type="number" id="edAdultsDinner" min="0" placeholder="Adultos cena">
            <input type="number" id="edKidsDinner" min="0" placeholder="Ni√±os cena (50%)">
          </div>
          <div class="inline" style="gap:10px">
            <input type="number" id="edAdultsAfter" min="0" placeholder="Adultos despu√©s">
            <input type="number" id="edKidsAfter" min="0" placeholder="Ni√±os despu√©s">
          </div>
          <div class="inline" style="gap:10px">
            <input type="text" id="edPriceAfter" placeholder="Precio despu√©s (adultos)" inputmode="decimal">
            <input type="text" id="edPriceAfterKids" placeholder="Precio despu√©s (ni√±os)" inputmode="decimal">
          </div>
          <div class="inline" style="justify-content:flex-end"><button id="savePeople" type="button">Guardar cambios</button></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 6px">Reprecio por persona (cena)</h3>
          <div class="inline">
            <input id="newPricePer" type="text" placeholder="Nuevo precio cena" inputmode="decimal">
            <button id="btnReprice" type="button">Aplicar</button>
          </div>
          <div class="small">Afecta solo las <b>unidades pendientes</b> (adulto=1, ni√±o=0.5); lo pagado queda congelado al precio anterior.</div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ======== /PANEL ======== -->

<!-- ===== AUTH ===== -->
<div id="authBk" style="display:none">
  <div id="authCard" class="card">
    <div class="auth-tabs">
      <div class="chip active" data-auth="login">Iniciar sesi√≥n</div>
      <div class="chip" data-auth="register">Crear cuenta</div>
    </div>
    <div id="authLogin">
      <label>Email</label><input id="alEmail" type="email" placeholder="tu@email.com">
      <label>Contrase√±a</label><input id="alPass" type="password" placeholder="m√≠n. 6 caracteres">
      <div class="inline" style="justify-content:space-between">
        <button id="doLogin">Entrar</button>
        <button id="doGoogle" class="ghost">Entrar con Google</button>
        <button id="doReset" class="ghost">Olvid√© mi contrase√±a</button>
        <button id="closeAuth" class="ghost">Cancelar</button>
      </div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label><input id="arEmail" type="email">
      <label>Contrase√±a</label><input id="arPass" type="password">
      <div class="inline" style="justify-content:space-between">
        <button id="doRegister">Crear cuenta</button>
        <button id="closeAuth2" class="ghost">Cancelar</button>
      </div>
    </div>

    <div class="inline" style="justify-content:flex-end;margin-top:8px">
      <button id="doGuest" class="ghost" type="button">Usar sin cuenta (este dispositivo)</button>
    </div>

    <div class="small" id="authMsg"></div>
  </div>
</div>

<script>
/* ============ Firebase SAFE INIT (con tus credenciales) ============ */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCrcpg531_Lzy6TBAfvei2Vbzcln99gUW0",
  authDomain: "ok-pagos-25803.firebaseapp.com",
  projectId: "ok-pagos-25803",
  storageBucket: "ok-pagos-25803.appspot.com",
  messagingSenderId: "704291450097",
  appId: "1:704291450097:web:f0ce42da229f0d1d30cd50",
  measurementId: "G-FKG9PR8VMH"
};

const CLOUD_ENABLED =
  !!(FIREBASE_CONFIG.apiKey) &&
  !/^TU_|^YOUR_/i.test(FIREBASE_CONFIG.apiKey);

let auth=null, db=null;

const saveModeEl = document.getElementById('saveMode');
const whoEl      = document.getElementById('who');
const btnAuth    = document.getElementById('btnAuth');
const btnLogout  = document.getElementById('btnLogout');
const authBk     = document.getElementById('authBk');
const authMsg    = document.getElementById('authMsg');

const alEmail = document.getElementById('alEmail');
const alPass  = document.getElementById('alPass');
const arEmail = document.getElementById('arEmail');
const arPass  = document.getElementById('arPass');

const doLogin    = document.getElementById('doLogin');
const doRegister = document.getElementById('doRegister');
const doGoogle   = document.getElementById('doGoogle');
const doGuest    = document.getElementById('doGuest');
const doReset    = document.getElementById('doReset');

const SKIP_LOGIN = 'ok_ev_skip_login';

function openAuth(){ authBk.style.display='flex'; }
function closeAuth(){ authBk.style.display='none'; authMsg.textContent=''; }

/* --- Mapeo de errores a mensajes claros --- */
function mapAuthError(e){
  const code = e?.code || '';
  const M = {
    'auth/email-already-in-use': 'Ya existe una cuenta con este email. Inici√° sesi√≥n o restablec√© la contrase√±a.',
    'auth/invalid-email':        'Email no v√°lido.',
    'auth/user-not-found':       'No existe una cuenta con ese email.',
    'auth/wrong-password':       'Contrase√±a incorrecta.',
    'auth/too-many-requests':    'Demasiados intentos. Prob√° m√°s tarde.'
  };
  return 'Firebase: ' + (M[code] || e.message || 'Error desconocido');
}

if (CLOUD_ENABLED) {
  firebase.initializeApp(FIREBASE_CONFIG);
  auth = firebase.auth();
  db   = firebase.firestore();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  btnAuth.onclick  = ()=>{ localStorage.removeItem(SKIP_LOGIN); openAuth(); };
  btnLogout.onclick= ()=> auth.signOut();

  document.getElementById('closeAuth').onclick = closeAuth;
  document.getElementById('closeAuth2').onclick = closeAuth;

  document.querySelectorAll('.auth-tabs .chip').forEach(ch=>{
    ch.onclick=()=>{
      const which=ch.dataset.auth;
      document.querySelectorAll('.auth-tabs .chip').forEach(x=>x.classList.toggle('active',x===ch));
      document.getElementById('authLogin').style.display=which==='login'?'block':'none';
      document.getElementById('authReg').style.display  =which==='register'?'block':'none';
      authMsg.textContent='';
    };
  });

  doLogin.onclick=async()=>{
    try{
      await auth.signInWithEmailAndPassword(alEmail.value.trim(), alPass.value);
      closeAuth();
    }catch(e){ authMsg.textContent = mapAuthError(e); }
  };

  doRegister.onclick=async()=>{
    try{
      await auth.createUserWithEmailAndPassword(arEmail.value.trim(), arPass.value);
      closeAuth();
    }catch(e){
      if(e.code === 'auth/email-already-in-use'){
        alEmail.value = arEmail.value.trim();
        document.querySelector('.auth-tabs .chip[data-auth="login"]').click();
        authMsg.textContent = 'Ya existe una cuenta con este email. Inici√° sesi√≥n o presion√° "Olvid√© mi contrase√±a".';
      }else{
        authMsg.textContent = mapAuthError(e);
      }
    }
  };

  doGoogle.onclick=async()=>{
    try{
      await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      closeAuth();
    }catch(e){ authMsg.textContent = mapAuthError(e); }
  };

  doReset.onclick = async ()=>{
    const email = (alEmail.value || arEmail.value || '').trim();
    if(!email){ authMsg.textContent = 'Escrib√≠ tu email arriba primero.'; return; }
    try{
      await auth.sendPasswordResetEmail(email);
      authMsg.textContent = 'Te enviamos un correo para restablecer tu contrase√±a.';
    }catch(e){ authMsg.textContent = mapAuthError(e); }
  };

  doGuest.onclick=()=>{ localStorage.setItem(SKIP_LOGIN,'1'); closeAuth(); };

  document.addEventListener('DOMContentLoaded', ()=>{
    if(!auth.currentUser && !localStorage.getItem(SKIP_LOGIN)) openAuth();
  });

} else {
  console.warn('Firebase desactivado ‚Üí modo invitado (localStorage).');
  auth = {
    currentUser: null,
    onAuthStateChanged: (cb)=> cb(null),
    signOut: async()=>{}
  };
  db = null;
  saveModeEl.textContent = 'Modo invitado (local)';
  whoEl.textContent = '‚Äî';
  btnAuth.style.display = 'none';
  btnLogout.style.display = 'none';
  authBk.style.display = 'none';
  localStorage.setItem(SKIP_LOGIN,'1');
}

const isAuthed = ()=> !!(auth && auth.currentUser && auth.currentUser.uid);
const UCOL = (path)=> db.collection('users').doc(auth.currentUser.uid).collection(path);

/* ===== Utilidades ===== */
/* Conversor robusto: respeta numbers; detecta ‚Äú,‚Äù o ‚Äú.‚Äù como decimal seg√∫n el texto  */
function num(v){
  if (typeof v === 'number' && isFinite(v)) return v;
  const s = (''+(v??'')).trim();
  if (!s) return 0;
  const hasComma = s.includes(',');
  const hasDot   = s.includes('.');
  if (hasComma && !hasDot){
    // Formato 1.234.567,89  (solo comas como decimal)
    return parseFloat(s.replace(/\./g,'').replace(',', '.').replace(/[^\d.+-Ee]/g,'')) || 0;
  }
  if (hasDot && hasComma){
    // Mixto ‚Üí asumir coma decimal
    return parseFloat(s.replace(/\./g,'').replace(',', '.').replace(/[^\d.+-Ee]/g,'')) || 0;
  }
  // Solo puntos o sin separadores ‚Üí asumir punto decimal o entero limpio
  return parseFloat(s.replace(/,/g,'').replace(/[^\d.+-Ee]/g,'')) || 0;
}
const money = (n)=> '$ ' + Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
const isHttp = (u)=> u && /^https?:\/\//i.test(u);
const uid = ()=>'id_'+Math.random().toString(36).slice(2)+Date.now();

/* ===== Storage local ===== */
const K = { EVENTS:'ok_ev_events', EXTRAS:'ok_ev_extras', MEDIA:'ok_ev_media', PAYSEQ:'ok_ev_payseq', LOGO:'ok_logo' };
const store = { get:(k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch{ return def; } }, set:(k,v)=> localStorage.setItem(k, JSON.stringify(v)) };

/* ===== Logo ===== */
const logoPreview = document.getElementById('logoPreview');
const logoFile = document.getElementById('logoFile');
const logoGuardar = document.getElementById('logoGuardar');
const logoStatus = document.getElementById('logoStatus');
(function(){ const saved=localStorage.getItem(K.LOGO); if(saved){ logoPreview.src=saved; logoStatus.textContent='Logo guardado'; }})();
logoFile.addEventListener('change', ()=>{ if(!logoFile.files?.length) return; const f=logoFile.files[0]; const r=new FileReader(); r.onload=()=>{ logoPreview.src=r.result; logoStatus.textContent='Logo listo (sin guardar)'; }; r.readAsDataURL(f); });
logoGuardar.addEventListener('click', ()=>{ try{ localStorage.setItem(K.LOGO, logoPreview.src); logoStatus.textContent='Logo guardado'; }catch(e){ alert('No se pudo guardar el logo.'); }});

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
                 document.querySelectorAll('.tabpanel').forEach(x=>x.classList.remove('active'));
                 t.classList.add('active'); document.getElementById('tab-'+t.dataset.tab).classList.add('active');};
});

/* ===== Semillas cat√°logo ===== */
const BASE_EXTRAS = [
  {type:'extra', name:"Chispas Fr√≠as X2", price:79000},{type:'extra', name:"Candy Bar / Candy Golosinas", price:79000},
  {type:'extra', name:"Decoraci√≥n de Mesa Principal", price:90000},{type:'extra', name:"Decoraci√≥n de Sal√≥n con Telas", price:95000},
  {type:'extra', name:"Sill√≥n de Quincea√±era", price:95000},{type:'extra', name:"Candy Glitter", price:95000},
  {type:'extra', name:"Decoraci√≥n Tras Mesa Principal", price:95000},{type:'extra', name:"T√∫nel de Luces", price:100000},
  {type:'extra', name:"Letras Luminosas", price:105000},{type:'extra', name:"Living para 100 personas", price:120000},
  {type:'extra', name:"Pantalla y Proyector", price:135000},{type:'extra', name:"Barra Tropical con y sin Alcohol", price:145000},
  {type:'extra', name:"Altar Civil", price:145000},{type:'extra', name:"Centro de Mesas x 10U", price:150000},
  {type:'extra', name:"Cotill√≥n para Fiestas", price:150000},{type:'extra', name:"C√°mara 360", price:165000},
  {type:'extra', name:"Robot Led", price:225000},{type:'extra', name:"Cabina Fotogr√°fica", price:225000},
  {type:'extra', name:"Fondo para Fotos", price:225000},{type:'extra', name:"Fuegos Artificiales", price:350000},
  {type:'extra', name:"Fotograf√≠a", price:354000},{type:'extra', name:"Video", price:354000},
];
const BASE_COMBOS = [
  {type:'combo', name:"EXTRAS COMBO ‚Äì N¬∞1", price:530000},
  {type:'combo', name:"EXTRAS COMBO ‚Äì N¬∞1 (B)", price:390000},
  {type:'combo', name:"EXTRAS COMBO ‚Äì N¬∞2", price:885000},
  {type:'combo', name:"EXTRAS COMBO ‚Äì N¬∞2 (B)", price:750000},
  {type:'combo', name:"EXTRAS COMBO ‚Äì N¬∞3", price:950000},
];

/* ===== Estado ===== */
let extras = store.get(K.EXTRAS, []);
if(!extras.length){ extras=[...BASE_EXTRAS, ...BASE_COMBOS].map(e=>({id:uid(), ...e})); store.set(K.EXTRAS, extras); }
let events = store.get(K.EVENTS, []);
let mediaMap = store.get(K.MEDIA, {});
let paySeqLocal = store.get(K.PAYSEQ, 0);
function nextSeqLocal(){ paySeqLocal++; store.set(K.PAYSEQ, paySeqLocal); return String(paySeqLocal).padStart(12,'0'); }

/* ===== Historial (Deshacer) ===== */
const historyStack = {}; // { [eventId]: [snap1, snap2, ...] }
function snapshot(ev){ return JSON.parse(JSON.stringify(ev)); }
function updateUndoButton(){
  const b = document.getElementById('pUndo');
  if(!currentEventId){ b.disabled = true; return; }
  const stack = historyStack[currentEventId] || [];
  b.disabled = stack.length === 0;
}

/* ===== AUTH listener ===== */
let unsubEvents=null, unsubExtras=null, unsubMedia=null;
if(auth && auth.onAuthStateChanged){
auth.onAuthStateChanged(async (user)=>{
  if(user){
    whoEl.textContent = user.email||user.uid;
    saveModeEl.textContent = 'Guardado en la cuenta (nube)';
    btnAuth.style.display='none'; btnLogout.style.display='inline-block';
    localStorage.removeItem(SKIP_LOGIN);

    if(unsubEvents) unsubEvents(); if(unsubExtras) unsubExtras(); if(unsubMedia) unsubMedia();

    unsubExtras = UCOL('extras').orderBy('name').onSnapshot(s=>{
      extras = []; s.forEach(d=> extras.push(d.data()));
      if(!extras.length){
        const batch = db.batch();
        [...BASE_EXTRAS, ...BASE_COMBOS].forEach(e=>{ const id=uid(); batch.set(UCOL('extras').doc(id), {id, ...e}); });
        batch.commit();
      }
      store.set(K.EXTRAS, extras); fillCatalogSelects(); renderCatalog();
    });

    unsubEvents = UCOL('events').orderBy('date','desc').onSnapshot(s=>{
      events = []; s.forEach(d=> events.push(d.data()));
      store.set(K.EVENTS, events); renderEventList();
      if(currentEventId){
        const still = events.find(e=>e.id===currentEventId);
        if(still){ renderEventItems(); renderPayments(); refreshSummary(); fillEditPeople(still); updateUndoButton(); }
        else { evPanelBk.style.display='none'; currentEventId=null; updateUndoButton(); }
      }
    });

    unsubMedia = UCOL('media').onSnapshot(s=>{
      mediaMap={}; s.forEach(d=> mediaMap[d.id]=d.data().arr||[]);
      store.set(K.MEDIA, mediaMap);
    });

  }else{
    whoEl.textContent='‚Äî';
    saveModeEl.textContent='Modo invitado (local)';
    btnAuth.style.display='inline-block'; btnLogout.style.display='none';
    if(unsubEvents) unsubEvents(); if(unsubExtras) unsubExtras(); if(unsubMedia) unsubMedia();

    extras = store.get(K.EXTRAS, extras);
    events = store.get(K.EVENTS, events);
    mediaMap = store.get(K.MEDIA, mediaMap);

    if(CLOUD_ENABLED && !localStorage.getItem(SKIP_LOGIN)) openAuth();

    renderEventList(); fillCatalogSelects(); renderCatalog();
  }
});
}

/* ===== Refs UI (crear) ===== */
const evForm = document.getElementById('evForm');
const evType = document.getElementById('evType');
const evName = document.getElementById('evName');
const evDate = document.getElementById('evDate');
const errName = document.getElementById('errName');
const errDate = document.getElementById('errDate');
const errPrice = document.getElementById('errPrice');
const evPricePer = document.getElementById('evPricePer');
const evPricePerKids = document.getElementById('evPricePerKids');
const evProvince = document.getElementById('evProvince');
const evSalon = document.getElementById('evSalon');
const evOption = document.getElementById('evOption');

const evAdultsDinner = document.getElementById('evAdultsDinner');
const evKidsDinner = document.getElementById('evKidsDinner');
const evAdultsAfter = document.getElementById('evAdultsAfter');
const evKidsAfter = document.getElementById('evKidsAfter');
const evPriceAfter = document.getElementById('evPriceAfter');
const evPriceAfterKids = document.getElementById('evPriceAfterKids');

const evBasePreview = document.getElementById('evBasePreview');

const newExFor = document.getElementById('newExFor');
const newExQty = document.getElementById('newExQty');
const newExPrice = document.getElementById('newExPrice');
const newAddEx = document.getElementById('newAddEx');
const newExList = document.getElementById('newExList');
const newExTotal = document.getElementById('newExTotal');
const newSumBase = document.getElementById('newSumBase');
const newSumExtras = document.getElementById('newSumExtras');
const newSumTotal = document.getElementById('newSumTotal');
const newClear = document.getElementById('newClear');

const prevAdultsDinner = document.getElementById('prevAdultsDinner');
const prevKidsDinner = document.getElementById('prevKidsDinner');
const prevAdultsAfter = document.getElementById('prevAdultsAfter');
const prevKidsAfter = document.getElementById('prevKidsAfter');

/* ===== Refs UI (cat√°logo) ===== */
const exType = document.getElementById('exType');
const exName = document.getElementById('exName');
const exPrice = document.getElementById('exPrice');
const exCreate = document.getElementById('exCreate');
const exSelectFiles = document.getElementById('exSelectFiles');
const exList = document.getElementById('exList');
const exMedia = document.getElementById('exMedia');
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const btnUpload = document.getElementById('btnUpload');
const exLink = document.getElementById('exLink');
const btnAddLink = document.getElementById('btnAddLink');

/* ===== Refs UI (lista) ===== */
const evSearch = document.getElementById('evSearch');
const evList = document.getElementById('evList');
const provChips = Array.from(document.querySelectorAll('.subtabs .chip'));

/* ===== Refs UI (panel) ===== */
const evPanelBk = document.getElementById('evPanelBk');
const pClose = document.getElementById('pClose');
const pDelete = document.getElementById('pDelete');
const pUndo   = document.getElementById('pUndo');
const pEvName = document.getElementById('pEvName');
const pEvMeta = document.getElementById('pEvMeta');

const exForEvent = document.getElementById('exForEvent');
const exQty = document.getElementById('exQty');
const exPriceOverride = document.getElementById('exPriceOverride');
const addExtraToEvent = document.getElementById('addExtraToEvent');
const evExtrasList = document.getElementById('evExtrasList');
const evExtrasTotal = document.getElementById('evExtrasTotal');
const evClearExtras = document.getElementById('evClearExtras');

const payAmount = document.getElementById('payAmount');
const payMethod = document.getElementById('payMethod');
const payTarget = document.getElementById('payTarget'); // NUEVO
const payPerson = document.getElementById('payPerson'); // NUEVO
const payProof  = document.getElementById('payProof');
const payUpload = document.getElementById('payUpload');
const payProofLink = document.getElementById('payProofLink');
const payUseLink = document.getElementById('payUseLink');
const proofStatus = document.getElementById('proofStatus');
const paySave = document.getElementById('paySave');
const btnGeneralReceipt = document.getElementById('btnGeneralReceipt');
const payTotal = document.getElementById('payTotal');
const payList = document.getElementById('payList');

const newPricePer = document.getElementById('newPricePer');

const sumSalon = document.getElementById('sumSalon');
const sumPricePer = document.getElementById('sumPricePer');
const sumBase = document.getElementById('sumBase');
const sumExtras = document.getElementById('sumExtras');
const sumTotal = document.getElementById('sumTotal');
const sumPaid = document.getElementById('sumPaid');
const sumRemain = document.getElementById('sumRemain');

const sumAdultsDinner = document.getElementById('sumAdultsDinner');
const sumKidsDinner = document.getElementById('sumKidsDinner');
const sumAdultsAfter = document.getElementById('sumAdultsAfter');
const sumKidsAfter = document.getElementById('sumKidsAfter');
const sumAfterPrices = document.getElementById('sumAfterPrices');
const sumExtrasInline = document.getElementById('sumExtrasInline');

const editSalon = document.getElementById('editSalon');
const saveSalon = document.getElementById('saveSalon');

const edAdultsDinner = document.getElementById('edAdultsDinner');
const edKidsDinner = document.getElementById('edKidsDinner');
const edAdultsAfter = document.getElementById('edAdultsAfter');
const edKidsAfter = document.getElementById('edKidsAfter');
const edPriceAfter = document.getElementById('edPriceAfter');
const edPriceAfterKids = document.getElementById('edPriceAfterKids');
const savePeople = document.getElementById('savePeople');

let currentEventId = null;
let lastUploadedProofUrl = null;
let lastUploadedProofKind = null;
let newEventItems = [];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  fillCatalogSelects(); renderCatalog(); renderEventList(); updateNewPreview();

  const newKidsLbl = document.getElementById('newKidsLbl');
  if (newKidsLbl) {
    const hasKidsPrice = num(evPricePerKids.value || 0) > 0;
    newKidsLbl.textContent = hasKidsPrice ? '' : ' (50%)';
  }

  ['input','change'].forEach(evt=>{
    [evAdultsDinner,evKidsDinner,evAdultsAfter,evKidsAfter,evPricePer,evPriceAfter,evPriceAfterKids]
      .forEach(el=> el.addEventListener(evt, updateNewPreview));
  });

  provChips.forEach(ch=>{
    ch.onclick=()=>{
      provChips.forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      renderEventList();
    };
  });

  // Deshacer
  pUndo.addEventListener('click', undoLast);

  // üëá NUEVO: click del bot√≥n "Recibo GENERAL (PDF)"
  btnGeneralReceipt.addEventListener('click', ()=>{
    if(!currentEventId) return alert('Abr√≠ un evento');
    generateGeneralReceipt(currentEventId);
  });
});

/* ===== Helpers ===== */
function fillCatalogSelects(){
  function fill(sel){
    sel.innerHTML='';
    const g1=document.createElement('optgroup'); g1.label='Extras';
    const g2=document.createElement('optgroup'); g2.label='Combos';
    extras.filter(x=>x.type==='extra').forEach(it=>{ const o=document.createElement('option'); o.value=it.id; o.textContent=`${it.name} ‚Äî ${money(it.price)}`; g1.appendChild(o); });
    extras.filter(x=>x.type==='combo').forEach(it=>{ const o=document.createElement('option'); o.value=it.id; o.textContent=`${it.name} ‚Äî ${money(it.price)}`; g2.appendChild(o); });
    sel.appendChild(g1); sel.appendChild(g2);
  }
  fill(newExFor); fill(exForEvent); fill(exSelectFiles);
}
function parseDateInput(v){ v=(v||'').trim(); if(!v) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; const m=v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(m){ const d=m[1].padStart(2,'0'), mo=m[2].padStart(2,'0'), y=m[3]; return `${y}-${mo}-${d}`; } return v; }
function getActiveProvince(){ const a=document.querySelector('.subtabs .chip.active'); return a?.dataset.prov || 'San Juan'; }

/* ===== Crear evento ===== */
evForm.addEventListener('submit', (e)=>{ e.preventDefault(); handleCreateEvent(); });
async function handleCreateEvent(){
  errName.textContent=errDate.textContent=errPrice.textContent='';
  const name=(evName.value||'').trim(); const date=parseDateInput(evDate.value);
  const pricePer=num(evPricePer.value);
  const pKc = Math.max(0, num(evPricePerKids.value||0)); // NUEVO
  if(!name){ errName.textContent=' requerido'; return; }
  if(!date){ errDate.textContent=' requerido'; return; }
  if(pricePer<=0){ errPrice.textContent=' inv√°lido'; return; }

  const ad= Math.max(0, num(evAdultsDinner.value));
  const kd= Math.max(0, num(evKidsDinner.value));
  const aa= Math.max(0, num(evAdultsAfter.value));
  const ka= Math.max(0, num(evKidsAfter.value));
  const pA = Math.max(0, num(evPriceAfter.value));
  const pK = Math.max(0, num(evPriceAfterKids.value));

  const id=uid();
  const payload={
    id,
    type:evType.value,
    name,
    date,
    province:evProvince.value||'San Juan',
    salon:(evSalon.value||'').trim()||null,
    optionLabel:(evOption.value||'').trim()||null,
    pricePer:pricePer,
    pricePerKids: pKc>0 ? pKc : null, // si null ‚Üí usa 50% de adultos}
    priceAfter:pA,
    priceAfterKids:pK,
    adultsDinner:ad,
    kidsDinner:kd,
    adultsAfter:aa,
    kidsAfter:ka,
    items:[...newEventItems.map(x=>({...x}))],
    payments:[],
    repriceLocks:[],
    createdAt:Date.now()
  };

  payload.baseTotal = baseOf(payload);

  if(isAuthed()){
    const ref = await UCOL('events').add(payload); await ref.update({id:ref.id});
  }else{
    events.unshift(payload); store.set(K.EVENTS, events);
  }

  // reset
  evType.value='15 a√±os'; evName.value=''; evDate.value='';
  evProvince.value='San Juan'; evSalon.value=''; evOption.value='';
  evPricePer.value=''; evPriceAfter.value=''; evPriceAfterKids.value='';
  evPricePerKids.value='';
  evAdultsDinner.value='100'; evKidsDinner.value='0'; evAdultsAfter.value='0'; evKidsAfter.value='0';
  newEventItems=[]; renderNewItems(); updateNewPreview(); renderEventList();
  alert('Evento creado ‚úÖ');
}

/* ===== √çtems NUEVO evento ===== */
newAddEx.addEventListener('click', ()=>{
  const id=newExFor.value; if(!id) return alert('Eleg√≠ un √≠tem');
  const base=extras.find(x=>x.id===id);
  const qty=Math.max(1,num(newExQty.value));
  const override=newExPrice.value===''?null:num(newExPrice.value);
  newEventItems.unshift({id:base.id,type:base.type,name:base.name,price:base.price,overridePrice:override,qty});
  newExQty.value='1'; newExPrice.value=''; renderNewItems(); updateNewPreview();
});
newClear.addEventListener('click', ()=>{ newEventItems=[]; renderNewItems(); updateNewPreview(); });
function renderNewItems(){
  newExList.innerHTML=''; let total=0;
  newEventItems.forEach((e,idx)=>{
    const price=num(e.overridePrice ?? e.price);
    const sub=price*e.qty; total+=sub;
    const div=document.createElement('div'); div.className='item';
    const chip=e.type==='combo'?'<span class="badge">Combo</span>':'<span class="badge">Extra</span>';
    div.innerHTML=`<div><b>${e.name}</b> ${chip}<div class="small">Precio: ${money(price)} ‚Äî Cant: ${e.qty} ‚Äî Subtotal: <b>${money(sub)}</b></div></div>
                   <button class="ghost" data-del="${idx}">Quitar</button>`;
    newExList.appendChild(div);
  });
  newExList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>{ newEventItems.splice(Number(b.dataset.del),1); renderNewItems(); updateNewPreview(); });
  newExTotal.textContent=money(total);
}
function updateNewPreview(){
  const tempEv={
    pricePerKids:num(evPricePerKids.value||0),
    pricePer:num(evPricePer.value),
    priceAfter:num(evPriceAfter.value),
    priceAfterKids:num(evPriceAfterKids.value),
    adultsDinner:Math.max(0,num(evAdultsDinner.value)),
    kidsDinner:Math.max(0,num(evKidsDinner.value)),
    adultsAfter:Math.max(0,num(evAdultsAfter.value)),
    kidsAfter:Math.max(0,num(evKidsAfter.value)),
    repriceLocks:[]
  };
  const base = baseOf(tempEv);
  let ex=0; newEventItems.forEach(e=>{ const price=num(e.overridePrice ?? e.price); ex+=price*num(e.qty); });
  prevAdultsDinner.textContent=tempEv.adultsDinner;
  prevKidsDinner.textContent=tempEv.kidsDinner;
  prevAdultsAfter.textContent=tempEv.adultsAfter;
  prevKidsAfter.textContent=tempEv.kidsAfter;
  newSumBase.textContent=money(base); newSumExtras.textContent=money(ex); newSumTotal.textContent=money(base+ex);
  evBasePreview.textContent='Total base estimado: '+money(base);
}

/* ===== Cat√°logo ===== */
function renderCatalog(){
  exList.innerHTML=''; extras.forEach(it=>{
    const row=document.createElement('div'); row.className='item';
    const badge=it.type==='combo'?'<span class="badge">Combo</span>':'<span class="badge">Extra</span>';
    row.innerHTML=`<div><b>${it.name}</b> ${badge}
       <div class="small">Precio cat√°logo: ${money(num(it.price))}</div>
       <div class="inline" style="margin-top:6px">
         <input type="text" class="name" value="${it.name}" data-id="${it.id}">
         <select class="kind" data-id="${it.id}">
           <option value="extra"${it.type!=='combo'?' selected':''}>Extra</option>
           <option value="combo"${it.type==='combo'?' selected':''}>Combo</option>
         </select>
         <input type="text" class="price" value="${num(it.price)}" data-id="${it.id}" inputmode="decimal">
         <button class="ghost" data-save="${it.id}" type="button">Guardar</button>
         <button class="ghost" data-del="${it.id}" type="button">Eliminar</button>
         <button class="ghost" data-view="${it.id}" type="button">Galer√≠a</button>
       </div></div>`;
    exList.appendChild(row);
  });
  exList.querySelectorAll('button[data-save]').forEach(b=>{
    b.onclick=async ()=>{
      const id=b.dataset.save;
      const name=exList.querySelector(`input.name[data-id="${id}"]`).value.trim();
      let price=num(exList.querySelector(`input.price[data-id="${id}"]`).value);
      const type=exList.querySelector(`select.kind[data-id="${id}"]`).value;
      const idx=extras.findIndex(x=>x.id===id); extras[idx]={...extras[idx],name,price,type};
      if(isAuthed()) await UCOL('extras').doc(id).set(extras[idx]);
      store.set(K.EXTRAS, extras); fillCatalogSelects(); renderCatalog();
    };
  });
  exList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=async ()=>{
    if(!confirm('Eliminar √≠tem?')) return;
    extras=extras.filter(x=>x.id!==b.dataset.del);
    if(isAuthed()) await UCOL('extras').doc(b.dataset.del).delete();
    store.set(K.EXTRAS, extras); fillCatalogSelects(); renderCatalog();
  });
  exList.querySelectorAll('button[data-view]').forEach(b=> b.onclick=()=> loadGallery(b.dataset.view));
}
exCreate.addEventListener('click', async ()=>{
  const name=(exName.value||'').trim(); if(!name) return alert('Nombre requerido');
  let price=num(exPrice.value||0); if(price<=0) return alert('Precio inv√°lido');
  const id=uid(); const obj={id,type:exType.value,name,price};
  extras.unshift(obj); if(isAuthed()) await UCOL('extras').doc(id).set(obj);
  store.set(K.EXTRAS, extras); exName.value=''; exPrice.value=''; fillCatalogSelects(); renderCatalog();
});

/* Archivos √≠tem (data URL o enlace) */
let selectedFiles=[];
function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
const okMediaSize = 900_000;
drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');selectedFiles=Array.from(e.dataTransfer.files||[]);alert(`${selectedFiles.length} archivo(s) listos`);});
fileInput.addEventListener('change',()=> selectedFiles = Array.from(fileInput.files||[]));
btnUpload.addEventListener('click', async ()=>{
  const id=exSelectFiles.value; if(!id) return alert('Eleg√≠ un √≠tem'); if(!selectedFiles.length) return alert('Seleccion√° archivos');
  mediaMap[id]=mediaMap[id]||[];
  for(const f of selectedFiles){
    const dataUrl=await fileToDataUrl(f);
    if((dataUrl||'').length>okMediaSize){ alert(`"${f.name}" pesa mucho. Peg√° un enlace en su lugar.`); continue; }
    mediaMap[id].unshift({name:f.name,type:f.type||'file',dataUrl,at:Date.now()});
  }
  selectedFiles=[]; fileInput.value='';
  if(isAuthed()) await UCOL('media').doc(id).set({arr:mediaMap[id]}); store.set(K.MEDIA, mediaMap);
  alert('Archivos guardados'); await loadGallery(id);
});
btnAddLink.addEventListener('click', async ()=>{
  const id=exSelectFiles.value; if(!id) return alert('Eleg√≠ un √≠tem');
  const link=(exLink.value||'').trim(); if(!isHttp(link)) return alert('Peg√° un enlace v√°lido');
  mediaMap[id]=mediaMap[id]||[]; mediaMap[id].unshift({name:link.split('/').pop(),type:'link',url:link,at:Date.now()});
  if(isAuthed()) await UCOL('media').doc(id).set({arr:mediaMap[id]}); store.set(K.MEDIA, mediaMap); exLink.value=''; await loadGallery(id);
});
async function loadGallery(id){
  exMedia.innerHTML=''; const arr=mediaMap[id]||[];
  if(!arr.length){ exMedia.innerHTML='<div class="small">Sin archivos</div>'; return; }
  arr.forEach(m=>{
    const box=document.createElement('div'); box.className='media';
    const pdf=(m.type||'').includes('pdf') || (m.url||'').toLowerCase().endsWith('.pdf') || (m.dataUrl||'').startsWith('data:application/pdf');
    const imgUrl=m.dataUrl||m.url;
    if(pdf){ box.innerHTML=`<div>PDF</div><a class="link" href="${imgUrl}" target="_blank">Abrir</a>`; }
    else if(imgUrl){ box.innerHTML=`<img src="${imgUrl}" alt=""><a class="link" href="${imgUrl}" target="_blank">Ver grande</a>`; }
    else{ box.innerHTML=`<div class="small">Archivo</div>`; }
    exMedia.appendChild(box);
  });
}

/* ===== C√°lculo base con ‚Äúcongelado‚Äù de unidades pagadas ===== */
function dinnerUnits(ev){
  const ad = Math.max(0, num(ev.adultsDinner||0));
  const kd = Math.max(0, num(ev.kidsDinner||0));

  const priceA = Math.max(0, num(ev.pricePer||0));
  const priceK = Math.max(0, num(ev.pricePerKids||0));

  // Si no hay precio adulto, evitamos dividir por 0 y caemos al 0.5 cl√°sico
  const kidsFactor = priceA > 0
    ? (priceK > 0 ? (priceK / priceA) : 0.5)
    : 0.5;

  // adulto = 1 unidad; ni√±o = factor relativo
  return ad + kidsFactor * kd;
}

function round2(x){ return Math.round((x||0)*100)/100; }

function baseDinner(ev){
  const totalUnits = round2(dinnerUnits(ev));
  const locks = Array.isArray(ev.repriceLocks) ? ev.repriceLocks : [];
  let lockedUnits=0, lockedAmount=0;
  locks.forEach(l=>{
    const u = (typeof l.units === 'number') ? l.units : num(l.units);
    const p = (typeof l.price === 'number') ? l.price : num(l.price);
    lockedUnits += u; lockedAmount += u*p;
  });
  lockedUnits = round2(lockedUnits);
  const currentUnits = round2(Math.max(0, totalUnits - lockedUnits));
  return lockedAmount + currentUnits * Math.max(0,num(ev.pricePer||0));
}
function baseAfters(ev){
  const priceAfter = Math.max(0,num(ev.priceAfter||0));
  const priceAfterKids = Math.max(0,num(ev.priceAfterKids||0));
  const aa = Math.max(0,num(ev.adultsAfter||0));
  const ka = Math.max(0,num(ev.kidsAfter||0));
  return aa*priceAfter + ka*priceAfterKids;
}
function baseOf(ev){
  return baseDinner(ev) + baseAfters(ev);
}
function computeTotals(ev){
  const base = baseOf(ev);
  let extrasTotal=0; (ev.items||[]).forEach(it=> extrasTotal += num(it.overridePrice??it.price)*num(it.qty||1));
  let paid=0; (ev.payments||[]).forEach(p=> paid += num(p.amount));
  const total=base+extrasTotal; const remain=Math.max(0,total-paid);
  return {
    base, extrasTotal, total, paid, remain,
    pricePer:num(ev.pricePer||0),
    priceAfter:num(ev.priceAfter||0),
    priceAfterKids:num(ev.priceAfterKids||0),
    ad:Math.max(0,num(ev.adultsDinner||0)),
    kd:Math.max(0,num(ev.kidsDinner||0)),
    aa:Math.max(0,num(ev.adultsAfter||0)),
    ka:Math.max(0,num(ev.kidsAfter||0))
  };
}
function renderEventList(){
  const q=(evSearch.value||'').toLowerCase(); const prov=getActiveProvince();
  evList.innerHTML='';
  events
    .filter(e=> (e.name||'').toLowerCase().includes(q))
    .filter(e=> prov==='Todos'?true:((e.province||'San Juan')===prov))
    .forEach(e=>{
      const t=computeTotals(e);
      const meta=`${e.type||'-'} ‚Ä¢ ${e.date||'sin fecha'} ‚Ä¢ ${e.province||'San Juan'}`;
      const salonTxt=e.salon?` ‚Ä¢ Sal√≥n: ${e.salon}`:'';
      const opt=e.optionLabel||'‚Äî';
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div>
          <b>${e.name||'-'}</b>
          <div class="small">${meta}${salonTxt}</div>
          <div class="small">Cena A:${t.ad} ‚Ä¢ N:${t.kd} | Despu√©s A:${t.aa} ‚Ä¢ N:${t.ka}</div>
        </div>
        <div class="inline">
          <span class="small">Opci√≥n: <b>${opt}</b></span>
          <span class="small">Precio cena: <b>${money(e.pricePer||0)}</b></span>
          <span class="small">Faltante: <b>${money(t.remain)}</b></span>
          <button class="ghost" data-open="${e.id}">Abrir</button>
          <button class="ghost" data-del="${e.id}">Eliminar</button>
        </div>`;
      evList.appendChild(div);
    });
  evList.querySelectorAll('button[data-open]').forEach(b=> b.onclick=()=> openEventPanel(b.dataset.open));
  evList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=> deleteEventDeep(b.dataset.del));
}
evSearch.addEventListener('input', renderEventList);

/* ===== Panel evento ===== */
pClose.addEventListener('click', ()=> evPanelBk.style.display='none');
pDelete.addEventListener('click', ()=> currentEventId && deleteEventDeep(currentEventId));
function openEventPanel(id){
  currentEventId=id; const ev=events.find(x=>x.id===id)||{};
  pEvName.textContent=ev.name||'Evento';
  pEvMeta.textContent=`${ev.type||'-'} ‚Ä¢ ${ev.date||'sin fecha'} ‚Ä¢ ${ev.province||'San Juan'}`;
  editSalon.value=ev.salon||'';
  renderEventItems(); renderPayments(); refreshSummary(); fillEditPeople(ev); updateUndoButton();
  evPanelBk.style.display='flex';
  // Mostrar/ocultar ‚Äú(50%)‚Äù seg√∫n si hay pricePerKids definido
const kidsLbl = document.getElementById('kidsLbl');
if (kidsLbl) {
  const hasKidsPrice = num(ev.pricePerKids || 0) > 0;
kidsLbl.textContent = hasKidsPrice ? '' : ' (50%)';
}
}


/* ===== Persistencia con historial ===== */
async function persistEvent(ev, push=true){
  if(push){
    const existing = events.find(x=>x.id===ev.id);
    if(existing){
      historyStack[ev.id] = historyStack[ev.id] || [];
      historyStack[ev.id].push(snapshot(existing));
      if(historyStack[ev.id].length>50) historyStack[ev.id].shift();
    }
  }
  if(isAuthed()) await UCOL('events').doc(ev.id).set(ev,{merge:true});
  else { const i=events.findIndex(x=>x.id===ev.id); if(i>-1) events[i]=ev; store.set(K.EVENTS, events); }
  if(ev.id===currentEventId) updateUndoButton();
}

async function undoLast(){
  const id=currentEventId; if(!id) return;
  const stack = historyStack[id]||[];
  if(!stack.length) { alert('No hay cambios para deshacer.'); return; }
  const prev = stack.pop();
  // Sobrescribir el evento con el snapshot anterior (sin push en historial)
  if(isAuthed()) await UCOL('events').doc(id).set(prev);
  const idx=events.findIndex(e=>e.id===id); if(idx>-1) events[idx]=prev; store.set(K.EVENTS, events);
  // Refrescar UI
  editSalon.value=prev.salon||'';
  renderEventItems(); renderPayments(); refreshSummary(); fillEditPeople(prev); updateUndoButton(); renderEventList();
}

/* ===== Sal√≥n ===== */
saveSalon.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId); ev.salon=(editSalon.value||'').trim()||null;
  await persistEvent(ev); refreshSummary(); renderEventList();
});

/* ===== Editar personas & precios despu√©s de cena ===== */
function fillEditPeople(ev){
  edAdultsDinner.value = ev.adultsDinner||0;
  edKidsDinner.value   = ev.kidsDinner||0;
  edAdultsAfter.value  = ev.adultsAfter||0;
  edKidsAfter.value    = ev.kidsAfter||0;
  edPriceAfter.value   = num(ev.priceAfter||0) || '';
  edPriceAfterKids.value = num(ev.priceAfterKids||0) || '';
}
savePeople.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  ev.adultsDinner = Math.max(0,num(edAdultsDinner.value));
  ev.kidsDinner   = Math.max(0,num(edKidsDinner.value));
  ev.adultsAfter  = Math.max(0,num(edAdultsAfter.value));
  ev.kidsAfter    = Math.max(0,num(edKidsAfter.value));
  ev.priceAfter   = Math.max(0,num(edPriceAfter.value));
  ev.priceAfterKids = Math.max(0,num(edPriceAfterKids.value));
  ev.baseTotal = baseOf(ev);
  await persistEvent(ev);
  refreshSummary(); renderEventList();
  alert('Cantidades y precios actualizados ‚úÖ');
});

/* ===== √çtems del evento ===== */
addExtraToEvent.addEventListener('click', async ()=>{
  if(!currentEventId) return alert('Abr√≠ un evento');
  const id=exForEvent.value; if(!id) return alert('Eleg√≠ un √≠tem');
  const base=extras.find(x=>x.id===id);
  const qty=Math.max(1,num(exQty.value));
  const override=exPriceOverride.value===''?null:num(exPriceOverride.value);
  const ev=events.find(e=>e.id===currentEventId); ev.items=ev.items||[];
  ev.items.unshift({itemId:id,type:base.type||'extra',name:base.name,price:num(base.price||0),overridePrice:override,qty});
  await persistEvent(ev); exQty.value='1'; exPriceOverride.value='';
  renderEventItems(); refreshSummary(); renderEventList();
});
function renderEventItems(){
  const ev=events.find(e=>e.id===currentEventId);
  evExtrasList.innerHTML=''; if(!ev){ evExtrasTotal.textContent=money(0); return; }
  let total=0;
  (ev.items||[]).forEach((e,idx)=>{
    const price=num(e.overridePrice ?? e.price);
    const sub=price*num(e.qty||1); total+=sub;
    const row=document.createElement('div'); row.className='item';
    const chip=e.type==='combo' ? '<span class="badge">Combo</span>' : '<span class="badge">Extra</span>';
    row.innerHTML=`<div><b>${e.name}</b> ${chip}
      <div class="small">Precio: ${money(price)} ‚Äî Cant: ${e.qty} ‚Äî Subtotal: <b>${money(sub)}</b></div>
      <div class="inline" style="margin-top:6px">
        <input type="text" class="price" value="${price}" data-idx="${idx}" inputmode="decimal">
        <input type="number" class="qty" value="${e.qty}" min="1" data-idx="${idx}">
        <button class="ghost" data-upd="${idx}" type="button">Actualizar</button>
        <button class="ghost" data-del="${idx}" type="button">Quitar</button>
      </div></div>`;
    evExtrasList.appendChild(row);
  });
  evExtrasTotal.textContent=money(total);
  evExtrasList.querySelectorAll('button[data-upd]').forEach(b=> b.onclick=async ()=>{
    const i=+b.dataset.upd; const ev=events.find(e=>e.id===currentEventId);
    let p=num(evExtrasList.querySelector(`input.price[data-idx="${i}"]`).value);
    const q=Math.max(1,num(evExtrasList.querySelector(`input.qty[data-idx="${i}"]`).value));
    ev.items[i].overridePrice=p; ev.items[i].qty=q; await persistEvent(ev);
    renderEventItems(); refreshSummary(); renderEventList();
  });
  evExtrasList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=async ()=>{
    const i=+b.dataset.del; const ev=events.find(e=>e.id===currentEventId); ev.items.splice(i,1);
    await persistEvent(ev); renderEventItems(); refreshSummary(); renderEventList();
  });
}
evClearExtras.addEventListener('click', async ()=>{
  const ev=events.find(e=>e.id===currentEventId); ev.items=[];
  await persistEvent(ev); renderEventItems(); refreshSummary(); renderEventList();
});

/* ===== Resumen / pagos / recibos ===== */
function refreshSummary(){
  const ev=events.find(e=>e.id===currentEventId);
  if(!ev){
    [sumBase,sumExtras,sumTotal,sumPaid,sumRemain,sumPricePer].forEach(el=>el.textContent=money(0));
    [sumAdultsDinner,sumKidsDinner,sumAdultsAfter,sumKidsAfter].forEach(el=>el.textContent='0');
    sumSalon.textContent='‚Äî'; sumAfterPrices.textContent=`${money(0)} / ${money(0)}`; sumExtrasInline.textContent=money(0); return;
  }
  const t=computeTotals(ev);
  sumSalon.textContent=ev.salon||'‚Äî';
  sumAdultsDinner.textContent=t.ad;
  sumKidsDinner.textContent=t.kd;
  sumAdultsAfter.textContent=t.aa;
  sumKidsAfter.textContent=t.ka;
const priceKids = Math.max(0, num(ev.pricePerKids||0)) || Math.max(0, num(ev.pricePer||0))*0.5;
sumPricePer.textContent = `${money(t.pricePer)} / Ni√±os: ${money(priceKids)}`;
  sumAfterPrices.textContent=`${money(t.priceAfter)} / ${money(t.priceAfterKids)}`;
  sumExtrasInline.textContent=money(t.extrasTotal);
  sumBase.textContent=money(t.base);
  sumExtras.textContent=money(t.extrasTotal);
  sumTotal.textContent=money(t.total);
  sumPaid.textContent=money(t.paid);
  sumRemain.textContent=money(t.remain);
  payTotal.textContent=money(t.paid);
}
function renderPayments(){
  const ev=events.find(e=>e.id===currentEventId);
  payList.innerHTML=''; if(!ev) return;

  (ev.payments||[]).slice().reverse().forEach(p=>{
    const proofHtml = p.proofUrl
      ? `<a class="link" data-proof="${p.proofUrl}" data-kind="${p.proofKind==='pdf'?'pdf':'img'}">
           ${/^http/i.test(p.proofUrl)?'Ver comprobante':'Ver ('+(p.proofKind==='pdf'?'PDF':'imagen')+')'}
         </a>`
      : '<span class="small">Sin comprobante</span>';

const destinoMap = {
  general:  'General / Mixto',
  extras:   'Extras',
  opciones: 'Opciones (cena)',
  despues:  'Despu√©s de cena'
};
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div>
<b>Destino: ${ (destinoMap[p.target || 'general'] || 'General / Mixto') }</b>
        <div class="small">${new Date(p.at).toLocaleString('es-AR')} ‚Äî ${p.method}</div>
        <div class="small">Monto: <b>${money(p.amount)}</b></div>
        ${proofHtml}
      </div>
      <div class="inline">
        <button class="ghost" data-receipt="${p.id}">Recibo</button>
        <button class="ghost" data-delpay="${p.id}">Eliminar</button>
      </div>`;
    payList.appendChild(div);
  });

  // ‚Üê estos listeners VAN FUERA del forEach
  payList.querySelectorAll('a[data-proof]').forEach(a=> a.onclick=()=> openProof(a.dataset.proof, a.dataset.kind));
  payList.querySelectorAll('button[data-receipt]').forEach(b=> b.onclick=()=> generateReceipt(currentEventId,b.dataset.receipt));
  payList.querySelectorAll('button[data-delpay]').forEach(b=> b.onclick=()=> deletePayment(b.dataset.delpay));
}

function openProof(url, kind){ if(!url) return; const w=window.open('', '_blank'); if(!w) return;
  if(kind==='pdf' || /\.pdf($|\?)/i.test(url) || url.startsWith('data:application/pdf')){ w.document.write(`<embed src="${url}" type="application/pdf" style="border:0;width:100%;height:100%"/>`); }
  else{ w.document.write(`<img src="${url}" style="max-width:100%;height:auto;display:block" />`); }
}
async function deletePayment(pid){
  const ev=events.find(e=>e.id===currentEventId); ev.payments=ev.payments.filter(p=>p.id!==pid);
  await persistEvent(ev); renderPayments(); refreshSummary(); renderEventList();
}

function loadProofFromFile(file){
  const okType=/^image\//i.test(file.type)||file.type==='application/pdf'||/\.pdf$/i.test(file.name); if(!okType) return alert('Solo imagen o PDF');
  if(file.size>1.8*1024*1024) return alert('El archivo supera 1.8 MB');
  const r=new FileReader();
  r.onload=()=>{ lastUploadedProofUrl=r.result; lastUploadedProofKind = file.type==='application/pdf'||/\.pdf$/i.test(file.name) ? 'pdf' : 'image';
    proofStatus.textContent= lastUploadedProofKind==='pdf' ? 'Comprobante listo (PDF) ‚úî' : 'Comprobante listo (imagen) ‚úî';
  };
  r.readAsDataURL(file);
}
payProof.addEventListener('change', ()=>{ if(payProof.files && payProof.files[0]) loadProofFromFile(payProof.files[0]); });
payUpload.addEventListener('click', ()=>{ if(!payProof.files || !payProof.files.length) return alert('Eleg√≠ un archivo (imagen o PDF)'); loadProofFromFile(payProof.files[0]); });
payUseLink.addEventListener('click', ()=>{ const link=(payProofLink.value||'').trim(); if(!isHttp(link)) return alert('Peg√° un enlace http/https v√°lido'); lastUploadedProofUrl=link; lastUploadedProofKind=/\.pdf($|\?)/i.test(link)?'pdf':'link'; proofStatus.textContent='Comprobante listo (enlace) ‚úî'; });
// INICIO CAMBIO: guardar pago con destino
paySave.addEventListener('click', async ()=>{
  if(!currentEventId) return alert('Abr√≠ un evento');
  const amount=num(payAmount.value); 
  if(amount<=0) return alert('Monto inv√°lido');
  if(!lastUploadedProofUrl) return alert('Sub√≠ o peg√° el COMPROBANTE (obligatorio)');

  const ev=events.find(e=>e.id===currentEventId); 
  ev.payments=ev.payments||[];

  ev.payments.push({
  id: uid(),
  amount,
  method: payMethod.value,
  target: payTarget.value || 'general',
  person: payPerson.value || 'adulto',   // <‚Äî NUEVO (adulto | nino)
  proofUrl: lastUploadedProofUrl,
  proofKind: lastUploadedProofKind || 'link',
  at: Date.now()
});


  payAmount.value=''; 
  payProof.value=''; 
  payProofLink.value='';
  lastUploadedProofUrl=null; 
  lastUploadedProofKind=null; 
  proofStatus.textContent='Sin comprobante';

  await persistEvent(ev); 
  renderPayments(); 
  refreshSummary(); 
  renderEventList();
  alert('Pago registrado ‚úÖ');
});
// FIN CAMBIO

/* ===== Numeraci√≥n recibos ===== */
async function nextSeqAny(){
  if(isAuthed()){
    const ref = UCOL('meta').doc('counters');
    const val = await db.runTransaction(async tx=>{
      const snap=await tx.get(ref); let cur=0; if(snap.exists) cur = Number(snap.data().payseq||0); cur++; tx.set(ref,{payseq:cur},{merge:true}); return cur;
    });
    return String(val).padStart(12,'0');
  }else{
    return nextSeqLocal();
  }
}

/* ===== Reprecio: congela unidades pagadas, nuevo precio solo en pendientes ===== */
document.getElementById('btnReprice').addEventListener('click', async ()=>{
  if(!currentEventId) return alert('Abr√≠ un evento');
  const ev=events.find(e=>e.id===currentEventId);
  const newP=num(newPricePer.value); if(newP<=0) return alert('Nuevo precio inv√°lido');

  const oldP=Math.max(0,num(ev.pricePer||0));
  if(newP===oldP){ newPricePer.value=''; return alert('El nuevo precio es igual al actual.'); }

  const totalUnits = round2(dinnerUnits(ev));
  const locks = Array.isArray(ev.repriceLocks)? ev.repriceLocks : (ev.repriceLocks=[]);
  const lockedUnits = round2(locks.reduce((a,l)=> a + (typeof l.units==='number'? l.units : num(l.units)), 0));
  const remainingUnits = round2(Math.max(0, totalUnits - lockedUnits));

  const totalPaid = (ev.payments||[]).reduce((a,p)=> a+Math.max(0,num(p.amount)), 0);
  const paidUnitsSoFar = round2(Math.min(totalUnits, totalPaid / Math.max(1,oldP)));

  const additionalUnitsToLock = round2(Math.max(0, Math.min(remainingUnits, paidUnitsSoFar - lockedUnits)));

  if(additionalUnitsToLock > 0){
    ev.repriceLocks.push({ units: additionalUnitsToLock, price: oldP, at: Date.now() });
  }

  ev.pricePer = newP;
  ev.baseTotal = baseOf(ev);
  await persistEvent(ev);
  newPricePer.value='';
  refreshSummary(); renderEventList();
  alert('Precio de cena actualizado ‚úÖ (las unidades pagadas quedaron al precio anterior)');
});

// === Guardar PDF con fallback (Safari/iOS) ===
function savePdf(doc, filename){
  try {
    doc.save(filename);
  } catch (e) {
    const url = doc.output('bloburl');
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display='none';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }
}

// ========= Helper: asegurar jsPDF =========
function ensureJsPDF(){
  if (!(window.jspdf && window.jspdf.jsPDF)) {
    alert('No se pudo cargar jsPDF. Verific√° la etiqueta de <script> de jsPDF o la conexi√≥n.');
    return null;
  }
  return window.jspdf.jsPDF;
}

// ========= Recibo individual (PDF) =========
async function generateReceipt(eventId, paymentId){
  const jsPDF = ensureJsPDF(); if(!jsPDF) return;
  const ev  = events.find(e => e.id === eventId);
  if(!ev){ alert('Evento no encontrado'); return; }
  const pay = (ev.payments||[]).find(p => p.id === paymentId);
  if(!pay){ alert('Pago no encontrado'); return; }

  const seq = await nextSeqAny();
  const doc = new jsPDF({ unit:'mm', format:'a4' });

  const W=210, H=297, M=10, BOXW=W-2*M, PAD=6, X0=M, Y0=M, innerX=X0+PAD, innerW=BOXW-2*PAD;
  const moneyFmt = n => '$ ' + Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const destinoMap = { general:'General / Mixto', extras:'Extras', opciones:'Opciones (cena)', despues:'Despu√©s de cena' };
  const personaMap = { adulto:'Adulto', nino:'Ni√±o' };

  // Marco
  doc.setLineWidth(0.25);
  doc.rect(X0, Y0, BOXW, H-2*M);

  // Logo
  try{
    const i=new Image(); i.crossOrigin='anonymous';
    i.src=document.getElementById('logoPreview').src;
    await new Promise(r=> i.onload=r);
    const c=document.createElement('canvas');
    c.width=i.width; c.height=i.height; c.getContext('2d').drawImage(i,0,0);
    doc.addImage(c.toDataURL('image/png'),'PNG', X0+BOXW-32, Y0+6, 24, 24);
  }catch{}

  // Encabezado
  doc.setFont('helvetica','bold'); doc.setFontSize(22);
  doc.text('RECIBO', X0+PAD, Y0+16);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text('OK EVENTOS ‚Äî CATERING Y EGRESADOS', X0+PAD, Y0+22);

  // N√∫mero y fecha
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text(`N¬∞ ${seq}`, X0+PAD, Y0+30);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(new Date(pay.at).toLocaleString('es-AR'), X0+PAD+40, Y0+30);

  // Evento
  const rowH=12, topY=Y0+36, wL=100, wR=innerW-wL;
  doc.rect(innerX, topY, wL, rowH);
  doc.rect(innerX+wL, topY, wR, rowH);
  doc.setFontSize(10);
  doc.text('Evento', innerX+2, topY+7);
  doc.setFont('helvetica','bold');
  doc.text(doc.splitTextToSize(ev.name||'‚Äî', wL-4), innerX+2, topY+11);
  doc.setFont('helvetica','normal');
  doc.text('Fecha / Provincia', innerX+wL+2, topY+7);
  doc.setFont('helvetica','bold');
  doc.text(`${ev.date||'‚Äî'} ‚Äî ${ev.province||'‚Äî'}`, innerX+wL+2, topY+11);

  // Detalle
  const y2 = topY + rowH + 6;
  const detalle = (pay.target==='opciones'||pay.target==='despues')
    ? `${destinoMap[pay.target]||'General'} ‚Äî ${personaMap[pay.person||'adulto']}`
    : (destinoMap[pay.target]||'General / Mixto');

  doc.rect(innerX, y2, innerW, 34);
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text(`RECIB√ç de: ${ev.name||'‚Äî'}`, innerX+2, y2+8);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(`Concepto: ${detalle}`, innerX+2, y2+16);
  doc.text(`M√©todo: ${pay.method||'-'}`, innerX+2, y2+24);
  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text(`Importe: ${moneyFmt(pay.amount)}`, innerX+2, y2+32);

  // Comprobante
  let y3 = y2 + 34 + 8;
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('Comprobante:', innerX, y3); y3 += 2;

  if (/^https?:\/\//i.test(pay.proofUrl)) {
    doc.textWithLink('Abrir comprobante', innerX, y3+6, { url: pay.proofUrl });
  } else if (/^data:image\//i.test(pay.proofUrl)) {
    const main = doc.getNumberOfPages();
    doc.addPage();
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('Comprobante (imagen)', X0+PAD, Y0+16);
    try{ doc.addImage(pay.proofUrl, 'JPEG', X0+PAD, Y0+22, BOXW-2*PAD, 220, undefined, 'FAST'); }catch{}
    doc.setPage(main);
    doc.textWithLink('Ver imagen incrustada (p√°g. sig.)', innerX, y3+6, { pageNumber: main+1 });
  } else if (/^data:application\/pdf/i.test(pay.proofUrl)) {
    doc.text('Adjunto PDF (no embebido).', innerX, y3+6);
  } else {
    doc.text('‚Äî', innerX, y3+6);
  }

  // Pie
  const Hline = H - M - 30;
  doc.line(innerX, Hline, innerX+60, Hline);
  doc.setFontSize(10);
  doc.text('Firma y aclaraci√≥n', innerX, Hline+6);

  const safe=(ev.name||'evento').replace(/[^\p{L}\p{N}_-]+/gu,'_');
  savePdf(doc, `Recibo_${safe}_${seq}.pdf`);
}

// ========= Recibo GENERAL ‚Äî layout igual al ejemplo (una sola fila de encabezado) =========
async function generateGeneralReceipt(eventId){
  const jsPDF = ensureJsPDF(); if(!jsPDF) return;
  const ev = events.find(e => e.id === eventId);
  if(!ev){ alert('Evento no encontrado'); return; }

  const t = computeTotals(ev);
  const pays = (ev.payments||[]).slice().sort((a,b)=>a.at-b.at);

  const seq = await nextSeqAny();
  const doc = new jsPDF({ unit:'mm', format:'a4' });

  // Constantes de layout
  const W=210, H=297, M=10, BOXW=W-2*M, PAD=6, X0=M, Y0=M, innerX=X0+PAD, innerW=BOXW-2*PAD;
  const moneyFmt = n => '$ ' + Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const destinoMap = { general:'General / Mixto', extras:'Extras', opciones:'Opciones (cena)', despues:'Despu√©s de cena' };
  const personaMap = { adulto:'Adulto', nino:'Adulto' /* mostr√°s 'Adulto' en tu ejemplo */ };

  // Marco general
  doc.setLineWidth(0.25);
  doc.rect(X0, Y0, BOXW, H-2*M);

  // Logo
  try{
    const i=new Image(); i.crossOrigin='anonymous';
    i.src=document.getElementById('logoPreview').src;
    await new Promise(r=> i.onload=r);
    const c=document.createElement('canvas');
    c.width=i.width; c.height=i.height; c.getContext('2d').drawImage(i,0,0);
    doc.addImage(c.toDataURL('image/png'),'PNG', X0+BOXW-32, Y0+6, 24, 24);
  }catch{}

  // Encabezado
  doc.setFont('helvetica','bold'); doc.setFontSize(22);
  doc.text('RECIBO GENERAL', X0+PAD, Y0+16);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text('OK EVENTOS ‚Äî CATERING Y EGRESADOS', X0+PAD, Y0+22);

  // N√∫mero y fecha (esquina superior izquierda, como tu ejemplo)
  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  doc.text(`N¬∞ ${seq}`, X0+PAD, Y0+30);
  doc.setFont('helvetica','normal');
  doc.text(new Date().toLocaleString('es-AR'), X0+PAD+32, Y0+30);

  // ===== Bloque de datos del evento (misma grilla del ejemplo)
  let y = Y0+36;
  const rowH=12, col1=innerX, col2=innerX+innerW/3, col3=innerX+innerW*2/3;

  // Caja completa y separadores
  const blockH = rowH*2;
  doc.rect(innerX, y, innerW, blockH);
  doc.line(col2, y, col2, y+blockH);
  doc.line(col3, y, col3, y+blockH);
  doc.line(innerX, y+rowH, innerX+innerW, y+rowH);

  // Fila 1
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('Nombre del evento', col1+2, y+5);
  doc.text('Fecha evento',      col2+2, y+5);
  doc.text('Provincia',         col3+2, y+5);
  doc.setFont('helvetica','bold');
  doc.text(ev.name||'‚Äî',        col1+2, y+10);
  doc.text(ev.date||'‚Äî',        col2+2, y+10);
  doc.text(ev.province||'‚Äî',    col3+2, y+10);

  // Fila 2
  doc.setFont('helvetica','normal');
  doc.text('Sal√≥n',             col1+2, y+rowH+5);
  doc.text('Opci√≥n/Plan',       col2+2, y+rowH+5);
  doc.text('Precio cena',       col3+2, y+rowH+5);
  doc.setFont('helvetica','bold');
  doc.text(ev.salon||'‚Äî',       col1+2, y+rowH+10);
  doc.text(ev.optionLabel||'‚Äî', col2+2, y+rowH+10);
  doc.text(moneyFmt(t.pricePer),col3+2, y+rowH+10);

  y += blockH + 10;

// ===== Pagos registrados (UNA sola fila de encabezado)
doc.setFont('helvetica','bold'); doc.setFontSize(12);
doc.text('Pagos registrados', innerX, y);
y += 6;

/*  NUEVO: columnas con anchos claros (suman 178 mm de innerW)
   Fecha: 35  | Cliente/Destino: 78 | M√©todo: 30 | Monto: 35
*/
const colW1 = 35, colW2 = 78, colW3 = 30, colW4 = 35;
const tcol1 = innerX;
const tcol2 = tcol1 + colW1;
const tcol3 = tcol2 + colW2;
const tcol4 = tcol3 + colW3;
const tableW = innerW, headerH = 10, rowGap = 8;

// Encabezado
doc.setLineWidth(0.25);
doc.rect(innerX, y, tableW, headerH);
doc.line(tcol2, y, tcol2, y+headerH);
doc.line(tcol3, y, tcol3, y+headerH);
doc.line(tcol4, y, tcol4, y+headerH);
doc.setFont('helvetica','bold'); doc.setFontSize(10);
doc.text('Fecha',           tcol1+2, y+6);
doc.text('Cliente/Destino', tcol2+2, y+6);
doc.text('M√©todo',          tcol3+2, y+6);
doc.text('Monto',           tcol4+2, y+6);

// Filas
let curY = y + headerH;
doc.setFont('helvetica','normal');
let sumPaid = 0;
const maxY = H - M - 60;

  for (const p of pays){
    sumPaid += Number(p.amount)||0;

    // Salto de p√°gina si no entra
    if (curY + rowGap > maxY){
      doc.addPage();
      curY = Y0+12;
      // Redibujar encabezado en nueva p√°gina
      doc.setFont('helvetica','bold'); doc.setFontSize(10);
      doc.rect(innerX, curY, tableW, headerH);
      doc.line(tcol2, curY, tcol2, curY+headerH);
      doc.line(tcol3, curY, tcol3, curY+headerH);
      doc.line(tcol4, curY, tcol4, curY+headerH);
      doc.text('Fecha', tcol1+2, curY+6);
      doc.text('Cliente/Destino', tcol2+2, curY+6);
      doc.text('M√©todo', tcol3+2, curY+6);
      doc.text('Monto',  tcol4+2, curY+6);
      curY += headerH;
      doc.setFont('helvetica','normal');
    }

    // Fila contorno
    doc.rect(innerX, curY, tableW, rowGap);
    doc.line(tcol2, curY, tcol2, curY+rowGap);
    doc.line(tcol3, curY, tcol3, curY+rowGap);
    doc.line(tcol4, curY, tcol4, curY+rowGap);

    const fecha = new Date(p.at).toLocaleDateString('es-AR');
    const destino = (destinoMap[p.target||'general']||'General / Mixto') +
                    (p.person ? ` ‚Äî ${personaMap[p.person]||''}` : '');
    const metodo = p.method||'-';
    const monto  = moneyFmt(p.amount);

    // Fecha
    doc.text(fecha, tcol1+2, curY+6);

    // Destino (clickeable al comprobante)
    if (p.proofUrl && /^https?:\/\//i.test(p.proofUrl)){
      doc.textWithLink(destino, tcol2+2, curY+6, { url: p.proofUrl });
    } else if (p.proofUrl && /^data:image\//i.test(p.proofUrl)){
      const here = doc.getNumberOfPages();
      doc.addPage();
      const targetPage = here+1;
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Comprobante (imagen)', X0+PAD, Y0+16);
      try{ doc.addImage(p.proofUrl,'JPEG', X0+PAD, Y0+22, BOXW-2*PAD, 220, undefined, 'FAST'); }catch{}
      doc.setPage(here);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.textWithLink(destino, tcol2+2, curY+6, { pageNumber: targetPage });
    } else {
      doc.text(destino, tcol2+2, curY+6);
    }

  // M√©todo y Monto
doc.text(metodo, tcol3+2, curY+6);
// NUEVO: monto alineado a la derecha dentro de la 4ta columna
doc.text(monto, tcol4 + colW4 - 2, curY+6, { align: 'right' });


    curY += rowGap;
  }

  // ===== Totales del evento (misma caja)
  curY += 8;
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text('Totales del evento', innerX, curY);
  curY += 4;

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.rect(innerX, curY, innerW, 24);
  doc.text(`Cena ‚Äî Adultos: ${t.ad} ‚Ä¢ Ni√±os: ${t.kd}`, innerX+2, curY+7);
  doc.text(`Despu√©s ‚Äî Adultos: ${t.aa} ‚Ä¢ Ni√±os: ${t.ka}`, innerX+innerW/2, curY+7);
  doc.text(`Extras: ${moneyFmt(t.extrasTotal)}`, innerX+2, curY+14);
  doc.text(`Precios despu√©s A/N: ${moneyFmt(t.priceAfter)} / ${moneyFmt(t.priceAfterKids)}`, innerX+innerW/2, curY+14);

  const remain = Math.max(0, t.total - sumPaid);
  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text(`TOTAL A PAGAR: ${moneyFmt(remain)}`, innerX, curY+32);

  // Firma
  const Hline = H - M - 30;
  doc.line(innerX, Hline, innerX+60, Hline);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('Firma y aclaraci√≥n', innerX, Hline+6);

  const safe=(ev.name||'evento').replace(/[^\p{L}\p{N}_-]+/gu,'_');
  savePdf(doc, `Recibo_GENERAL_${safe}_${seq}.pdf`);
}


// ===== Eliminar evento =====
async function deleteEventDeep(eventId){
  if(!confirm('¬øEliminar el evento y TODOS sus datos?')) return;
  if(isAuthed()) await UCOL('events').doc(eventId).delete();
  events = events.filter(e=>e.id!==eventId); store.set(K.EVENTS, events);
  if(currentEventId===eventId){ evPanelBk.style.display='none'; currentEventId=null; }
  renderEventList(); updateUndoButton(); alert('Evento eliminado ‚úÖ');
}

</script>
</body>
</html>
