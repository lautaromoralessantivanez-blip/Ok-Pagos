<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OK Eventos — Cloud</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<!-- jsPDF (para generar PDFs) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- html2canvas (por si lo necesitás en otra parte) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- PDF.js (para rasterizar 1ª hoja de PDFs de comprobantes) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
<script>
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js";
  }
</script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
:root{ --bg:#F5F4F0; --card:#fff; --text:#222629; --muted:#6B7280; --gold-1:#F2D15F; --gold-2:#CFA33C; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,Arial,sans-serif}
.wrap{max-width:1240px;margin:22px auto;padding:16px}
header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
header img{width:68px;height:68px;border-radius:12px;object-fit:cover}
h1{font-size:20px;margin:0}
.small{font-size:13px;color:var(--muted)}
.card{background:var(--card);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:14px}
input,select,button,textarea{font-family:inherit}
textarea{width:100%;padding:10px;border:1px solid #e9e9e9;border-radius:8px;margin:6px 0 10px;background:#fff;min-height:68px;resize:vertical}
input[type="text"],input[type="date"],input[type="number"],input[type="url"],input[type="email"],input[type="password"],select{width:100%;padding:10px;border:1px solid #e9e9e9;border-radius:8px;margin:6px 0 10px;background:#fff}
button{ color:#111;border:none;border-radius:10px;padding:10px 12px;cursor:pointer;
  background-image:linear-gradient(180deg,var(--gold-1),var(--gold-2));
  box-shadow:0 1px 0 rgba(0,0,0,.05), inset 0 .5px rgba(255,255,255,.6);
}
button:hover{filter:saturate(1.05) brightness(1.02)}
button[disabled]{opacity:.6;cursor:not-allowed}
button.ghost{background:#eee;color:#333;box-shadow:none}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 340px}
.list{max-height:340px;overflow:auto;border:1px dashed #eee;border-radius:10px;padding:8px}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px dashed #f0f0f0}
.inline{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.total{font-weight:700}
.qty{width:84px} .price{width:120px}
.tabs{display:flex;gap:6px;border-bottom:2px solid #e8e8e8;margin:10px 0 14px}
.tab{padding:10px 12px;border-radius:10px 10px 0 0;background:#ecebe6;cursor:pointer;font-weight:600}
.tab.active{background:#fff;border:1px solid #e8e8e8;border-bottom:none}
.tabpanel{display:none} .tabpanel.active{display:block}
.drop{border:2px dashed #cfcfcf;border-radius:12px;padding:16px;text-align:center;background:#fff}
.drop.drag{border-color:var(--gold-2);background:#fff8e6}
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.media{border:1px solid #eee;border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px;align-items:center}
.media img{max-width:100%;max-height:90px;object-fit:cover;border-radius:8px}
.link{color:#0b66ff;text-decoration:underline;cursor:pointer;font-size:13px}
.badge{font-size:11px;border:1px solid #e9e9e9;border-radius:999px;padding:2px 8px;margin-left:6px;background:#fafafa}

/* Panel / modal */
#evPanelBk{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-start;justify-content:center;z-index:60}
#evPanel{background:#fff;border-radius:14px;margin-top:24px;padding:16px;max-width:1100px;width:95%;max-height:88vh;overflow:auto}
.panelHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.close{background:#efefef;color:#222}
.err{color:#b00020;font-weight:600}

/* Subtabs provincia y tipo */
.subtabs, .typefilters{display:flex;gap:8px;margin:8px 0 6px;flex-wrap:wrap}
.subtabs .chip, .typefilters .chip{padding:6px 10px;border-radius:999px;border:1px solid #e8e8e8;background:#f7f7f5;cursor:pointer;font-weight:600}
.subtabs .chip.active, .typefilters .chip.active{background:#fff;border-color:#d9d9d9;box-shadow:0 1px 0 rgba(0,0,0,.04)}

/* AUTH overlay */
#authBk{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:80}
#authCard{background:#fff;border-radius:16px;padding:18px;max-width:480px;width:92%}
.auth-tabs{display:flex;gap:6px;margin-bottom:10px}
.auth-tabs .chip.active{background:#fff}

/* Estilos recibo DOM (si lo usás en PNG) */
#receiptHiddenRoot{position:fixed;left:-99999px;top:-99999px;visibility:hidden}
.rbox{width:860px;max-width:860px;background:#fff;border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:18px;font-family:Poppins,system-ui,Arial,sans-serif;color:#222}
.rhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.rtitle{font-size:24px;font-weight:700}
.rmeta{font-size:12px;color:#666}
.rrow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
.rcell{border:1px solid #eee;border-radius:10px;padding:10px}
.rcell b{display:block;margin-bottom:4px}
.rtable{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.rtable th,.rtable td{border:1px solid #eee;padding:6px;text-align:left}
.rtot{margin-top:12px;font-size:18px;font-weight:700}
.rfoot{margin-top:24px;border-top:1px dashed #ddd;padding-top:10px;font-size:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img id="logoPreview" src="https://placehold.co/300x300/ffffff/333333?text=OK+EVENTOS" alt="Logo" />
    <div style="flex:1">
      <h1>OK Eventos — Cloud</h1>
      <div class="small" id="saveMode">Modo invitado (local)</div>
      <div class="inline">
        <input type="file" id="logoFile" accept="image/*" />
        <button class="ghost" id="logoGuardar" type="button">Guardar logo</button>
        <span class="small" id="logoStatus">Logo temporal</span>
        <span class="small" style="margin-left:auto">Cuenta: <b id="who">—</b></span>
        <button class="ghost" id="btnAuth">Iniciar sesión</button>
        <button class="ghost" id="btnLogout" style="display:none">Cerrar sesión</button>
      </div>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="evNew">Eventos</div>
    <div class="tab" data-tab="ex">Catálogo de Extras</div>
    <div class="tab" data-tab="evList">Eventos creados</div>
  </div>

  <!-- ===== Crear evento ===== -->
  <div id="tab-evNew" class="tabpanel active">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Crear evento</h3>

          <form id="evForm" autocomplete="off">
            <label>Tipo de evento</label>
            <select id="evType">
              <option value="15 años">Cumple de 15</option>
              <option value="18 años">Cumple de 18</option>
              <option value="Casamiento">Casamiento</option>
              <option value="Fiesta de Egresados">Fiesta de egresados</option>
              <option value="Otro">Otro</option>
            </select>

            <label>Nombre / título <span class="err" id="errName"></span></label>
            <input required type="text" id="evName" placeholder="Ej: 15 de Estefy / Promo 2026" />

            <div class="row">
              <div class="col">
                <label>Fecha <span class="err" id="errDate"></span></label>
                <input type="date" id="evDate" />
              </div>
              <div class="col">
                <label>Provincia</label>
                <select id="evProvince">
                  <option>San Juan</option>
                  <option>Mendoza</option>
                </select>
              </div>
            </div>

            <label>Salón (opcional)</label>
            <input type="text" id="evSalon" placeholder="Ej: Salón Imperial / La Finca" />

            <label>Precio de salón (opcional)</label>
            <input type="text" id="evSalonPrice" placeholder="Ej: 300000" inputmode="decimal" />

            <label>Opción (paquete/plan del evento)</label>
            <input type="text" id="evOption" placeholder="Ej: Opción Dorada / Paquete Full" />

            <div class="row">
              <div class="col">
                <label>Precio por persona (cena) (ADULTOS) <span class="err" id="errPrice"></span></label>
                <input required type="text" id="evPricePer" placeholder="Ej: 15000" inputmode="decimal" />
              </div>
              <div class="col">
                <label>Precio por persona (cena) (NIÑOS) (opcional)</label>
                <input type="text" id="evPricePerKids" placeholder="Si queda vacío = 50% de adultos" inputmode="decimal" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Precio “después de cena” (adultos)</label>
                <input type="text" id="evPriceAfter" placeholder="Ej: 5000" inputmode="decimal" />
              </div>
              <div class="col">
                <label>Precio “después de cena” (niños)</label>
                <input type="text" id="evPriceAfterKids" placeholder="Ej: 3000" inputmode="decimal" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Adultos a cena</label>
                <input required type="number" id="evAdultsDinner" min="0" value="100" inputmode="numeric" />
              </div>
              <div class="col">
                <label>Niños a cena (50%)</label>
                <input type="number" id="evKidsDinner" min="0" value="0" inputmode="numeric" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label>Adultos después de cena</label>
                <input type="number" id="evAdultsAfter" min="0" value="0" inputmode="numeric" />
              </div>
              <div class="col">
                <label>Niños después de cena</label>
                <input type="number" id="evKidsAfter" min="0" value="0" inputmode="numeric" />
              </div>
            </div>

            <div class="small" id="evBasePreview">Total base estimado: $ 0,00</div>
            <div class="inline" style="justify-content:flex-end;margin-top:8px">
              <button id="evCreate" type="submit">Crear evento</button>
            </div>
          </form>
        </div>
      </div>

      <!-- ===== Extras/Combos para nuevo evento + Extra Personal ===== -->
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Extras/Combos para el NUEVO evento</h3>

          <input id="searchNewEx" type="text" placeholder="Buscar en catálogo de extras..."
                 style="width:100%;padding:10px;border:1px solid #e9e9e9;border-radius:8px;margin:0 0 6px" />

          <label>Elegir ítem</label>
          <select id="newExFor"><option value="">-- elegir extra o combo --</option></select>
          <div class="inline">
            <input type="number" id="newExQty" class="qty" min="1" value="1" />
            <input type="text" id="newExPrice" class="price" placeholder="Precio (opcional)" />
            <button id="newAddEx" type="button">Agregar</button>
          </div>
          <div class="small">Si ponés precio aquí, reemplaza el del catálogo <b>solo</b> para este evento.</div>

          <hr style="border:none;border-top:1px dashed #eee;margin:10px 0">

          <h4 style="margin:0 0 6px">Extra personal (solo para este evento)</h4>
          <div class="inline">
            <input type="text" id="persName" placeholder="Nombre del extra personal" style="flex:2">
            <input type="text" id="persPrice" class="price" placeholder="Precio" inputmode="decimal">
            <input type="number" id="persQty" class="qty" min="1" value="1">
            <button id="addPersonal" type="button">Agregar personal</button>
          </div>
          <div class="small">Estos ítems <b>no</b> se guardan en el catálogo y solo aparecen en este evento.</div>

          <h4 style="margin:10px 0 6px">Ítems</h4>
          <div id="newExList" class="list"></div>
          <div class="inline" style="justify-content:space-between;margin-top:8px">
            <div class="small">Total ítems: <span class="total" id="newExTotal">$ 0,00</span></div>
            <button class="ghost" id="newClear" type="button">Vaciar</button>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Resumen</h3>
          <div class="small">
            Cena — Adultos: <b id="prevAdultsDinner">0</b> • Niños<span id="newKidsLbl"> (50%)</span>: <b id="prevKidsDinner">0</b>
          </div>
          <div class="small">Después — Adultos: <b id="prevAdultsAfter">0</b> • Niños: <b id="prevKidsAfter">0</b></div>
          <div class="small">Base (todas personas): <b id="newSumBase">$ 0,00</b></div>
          <div class="small">Extras/Combos: <b id="newSumExtras">$ 0,00</b></div>
          <div class="small">TOTAL: <b id="newSumTotal" class="total">$ 0,00</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Catálogo ===== -->
  <div id="tab-ex" class="tabpanel">
    <div class="row">
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Nuevo — Extra o Combo</h3>
          <div class="inline" style="gap:10px">
            <div style="flex:1">
              <label>Tipo</label>
              <select id="exType">
                <option value="extra">Extra</option>
                <option value="combo">Combo</option>
              </select>
            </div>
            <div style="flex:2">
              <label>Nombre</label>
              <input type="text" id="exName" placeholder="Ej: Combo 1 / Candy Bar" />
            </div>
            <div style="flex:1">
              <label>Precio</label>
              <input type="text" id="exPrice" placeholder="Ej: 90000" inputmode="decimal" />
            </div>
          </div>
          <label>Descripción (opcional, para combos o extras)</label>
          <textarea id="exDesc" placeholder="Detalle del combo: incluye X, Y, Z..."></textarea>

          <button id="exCreate" type="button">Guardar</button>
        </div>

        <div class="card">
          <h3 style="margin:0 0 6px">Archivos del ítem</h3>
          <label>Elegir ítem</label>
          <select id="exSelectFiles"><option value="">-- elegir extra o combo --</option></select>

          <div id="drop" class="drop" style="margin-top:6px">
            Arrastrá y soltá PNG/JPG/PDF (máx. ~900 KB c/u) o
            <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="margin-left:6px" />
          </div>
          <div class="inline" style="margin-top:6px">
            <button id="btnUpload" type="button" class="ghost">Subir seleccionados</button>
            <span class="small">Si pesan más, pegá un enlace:</span>
          </div>
          <div class="inline">
            <input type="url" id="exLink" placeholder="https://drive.google.com/..." />
            <button id="btnAddLink" type="button" class="ghost">Guardar enlace</button>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="inline" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0 0 6px">Catálogo</h3>
            <input id="exSearch" type="text" placeholder="Buscar en catálogo..."
                   style="flex:1;min-width:220px;margin-left:10px;padding:10px;border:1px solid #e9e9e9;border-radius:8px">
          </div>
          <div id="exList" class="list"></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">Galería del ítem</h3>
          <div id="exMedia" class="media-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Eventos creados ===== -->
  <div id="tab-evList" class="tabpanel">
    <div class="card">
      <h3 style="margin:0 0 6px">Buscar evento</h3>
      <input type="text" id="evSearch" placeholder="Escribí el nombre...">

      <div class="subtabs">
        <div class="chip active" data-prov="Todos">Todos</div>
        <div class="chip" data-prov="Mendoza">Mendoza</div>
        <div class="chip" data-prov="San Juan">San Juan</div>
      </div>

      <div class="typefilters" id="typeFilters">
        <div class="chip" data-type="15 años">Cumple 15</div>
        <div class="chip" data-type="18 años">Cumple 18</div>
        <div class="chip" data-type="Casamiento">Casamiento</div>
        <div class="chip" data-type="Fiesta de Egresados">Egresados</div>
        <div class="chip" data-type="Otro">Otro</div>
      </div>

      <div id="evList" class="list" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- ======== PANEL DE EVENTO ======== -->
<div id="evPanelBk">
  <div id="evPanel" class="card">
    <div class="panelHead">
      <div>
        <h2 id="pEvName" style="margin:0 0 4px">Evento</h2>
        <div id="pEvMeta" class="small">—</div>
      </div>
      <div class="inline">
        <button id="pUndo" class="ghost" disabled>Deshacer</button>
        <button id="pDelete" class="ghost">Eliminar evento</button>
        <button id="pClose" class="close">Cerrar</button>
      </div>
    </div>

    <div class="row">
      <!-- Extras del evento -->
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Extras/Combos del evento</h3>

          <input id="searchExEvent" type="text" placeholder="Buscar en catálogo de extras..."
                 style="width:100%;padding:10px;border:1px solid #e9e9e9;border-radius:8px;margin:0 0 6px" />

          <label>Elegir ítem</label>
          <select id="exForEvent"><option value="">-- elegir extra o combo --</option></select>
          <div class="inline">
            <input type="number" id="exQty" class="qty" min="1" value="1" />
            <input type="text" id="exPriceOverride" class="price" placeholder="Precio (opcional)" />
            <button id="addExtraToEvent" type="button">Agregar</button>
          </div>

          <hr style="border:none;border-top:1px dashed #eee;margin:10px 0">
          <h4 style="margin:0 0 6px">Extra personal (solo para este evento)</h4>
          <div class="inline">
            <input type="text" id="persNameEv" placeholder="Nombre del extra personal" style="flex:2">
            <input type="text" id="persPriceEv" class="price" placeholder="Precio" inputmode="decimal">
            <input type="number" id="persQtyEv" class="qty" min="1" value="1">
            <button id="addPersonalEv" type="button">Agregar personal</button>
          </div>
          <div class="small">Estos ítems <b>no</b> se guardan en el catálogo; quedan solo en este evento.</div>

          <h4 style="margin:10px 0 6px">Ítems del evento</h4>
          <div id="evExtrasList" class="list"></div>
          <div class="inline" style="justify-content:space-between;margin-top:8px">
            <div class="small">Total extras/combos: <span class="total" id="evExtrasTotal">$ 0,00</span></div>
            <button class="ghost" id="evClearExtras" type="button">Vaciar</button>
          </div>
        </div>
      </div>

      <!-- Pagos -->
      <div class="col">
        <div class="card">
          <h3 style="margin:0 0 6px">Pagos</h3>

          <div class="inline" style="gap:10px">
            <input style="flex:1" id="payAmount" type="text" placeholder="Monto" inputmode="decimal">
            <select style="flex:1" id="payMethod">
              <option>Efectivo</option><option>Transferencia</option><option>Mercado Pago</option><option>Tarjeta</option><option>Otro</option>
            </select>
            <select style="flex:1" id="payTarget" title="A qué se destina este pago">
              <option value="general">General / Mixto</option>
              <option value="extras">Extras</option>
              <option value="salon">Salón</option>
              <option value="opciones">Opciones (cena)</option>
              <option value="despues">Después de cena</option>
            </select>
            <select style="flex:1" id="payPerson" title="Quién es">
              <option value="adulto">Adulto</option>
              <option value="nino">Niño</option>
            </select>
            <input style="flex:1" id="payDate" type="date" title="Fecha del pago">
          </div>

          <div class="inline" style="gap:10px;margin-top:6px">
            <input type="file" id="payProof" accept="image/*,application/pdf" style="flex:2">
            <span class="small"><b>Comprobante obligatorio</b> (imagen o PDF)</span>
          </div>

          <div class="inline" style="justify-content:flex-end;margin-top:6px">
            <button id="paySave" type="button">Guardar pago</button>
          </div>

          <h4 style="margin:10px 0 6px">Pagos guardados</h4>
          <div id="payList" class="list"></div>

          <div class="inline" style="justify-content:space-between;margin-top:8px">
            <div class="small">Total abonado: <span class="total" id="payTotal">$ 0,00</span></div>
            <div class="inline" style="gap:6px">
              <button id="btnGeneralReceipt" class="ghost" type="button">Recibo GENERAL (PDF)</button>
            </div>
          </div>
        </div>

        <!-- Resumen y ajustes -->
        <div class="row">
          <div class="col">
            <div class="card">
              <h3 style="margin:0 0 6px">Resumen</h3>
              <div class="small">Salón: <b id="sumSalon">—</b></div>
              <div class="small">Precio de salón: <b id="sumSalonPrice">$ 0,00</b></div>
              <div class="small">Cena — Adultos: <b id="sumAdultsDinner">0</b> • Niños<span id="kidsLbl"> (50%)</span>: <b id="sumKidsDinner">0</b></div>
              <div class="small">Después — Adultos: <b id="sumAdultsAfter">0</b> • Niños: <b id="sumKidsAfter">0</b></div>
              <div class="small">Precio/Persona (cena): <b id="sumPricePer">$ 0,00</b></div>
              <div class="small">Precio “después” Adultos/Niños: <b id="sumAfterPrices">$ 0,00 / $ 0,00</b></div>
              <div class="small">Extras: <b id="sumExtrasInline">$ 0,00</b></div>
              <div class="small">Base: <b id="sumBase">$ 0,00</b> — Extras: <b id="sumExtras">$ 0,00</b></div>
              <div class="small">TOTAL: <b id="sumTotal" class="total">$ 0,00</b> — Abonado: <b id="sumPaid">$ 0,00</b> — SALDO: <b id="sumRemain" class="total">$ 0,00</b></div>
            </div>
          </div>
          <div class="col">
            <div class="card">
              <h3 style="margin:0 0 6px">Editar salón</h3>
              <div class="inline">
                <input id="editSalon" type="text" placeholder="Nombre del salón">
              </div>
              <div class="inline" style="margin-top:6px">
                <input id="editSalonPrice" type="text" placeholder="Precio de salón (opcional)" inputmode="decimal">
              </div>
              <div class="inline" style="justify-content:flex-end">
                <button id="saveSalon" type="button">Guardar</button>
              </div>
            </div>

            <div class="card">
              <h3 style="margin:0 0 6px">Editar personas & precios “después de cena”</h3>
              <div class="inline" style="gap:10px">
                <input type="number" id="edAdultsDinner" min="0" placeholder="Adultos cena">
                <input type="number" id="edKidsDinner" min="0" placeholder="Niños cena (50%)">
              </div>
              <div class="inline" style="gap:10px">
                <input type="number" id="edAdultsAfter" min="0" placeholder="Adultos después">
                <input type="number" id="edKidsAfter" min="0" placeholder="Niños después">
              </div>
              <div class="inline" style="gap:10px">
                <input type="text" id="edPriceAfter" placeholder="Precio después (adultos)" inputmode="decimal">
                <input type="text" id="edPriceAfterKids" placeholder="Precio después (niños)" inputmode="decimal">
              </div>
              <div class="inline" style="justify-content:flex-end"><button id="savePeople" type="button">Guardar cambios</button></div>
            </div>

            <div class="card">
              <h3 style="margin:0 0 6px">Reprecio por persona (cena)</h3>
              <div class="inline">
                <input id="newPricePer" type="text" placeholder="Nuevo precio cena" inputmode="decimal">
                <button id="btnReprice" type="button">Aplicar</button>
              </div>
              <div class="small">Afecta solo las <b>unidades pendientes</b> (adulto=1, niño=0.5); lo pagado queda congelado al precio anterior.</div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
<!-- ======== /PANEL ======== -->

<!-- ===== AUTH ===== -->
<div id="authBk" style="display:none">
  <div id="authCard" class="card">
    <div class="auth-tabs">
      <div class="chip active" data-auth="login">Iniciar sesión</div>
      <div class="chip" data-auth="register">Crear cuenta</div>
    </div>
    <div id="authLogin">
      <label>Email</label><input id="alEmail" type="email" placeholder="tu@email.com">
      <label>Contraseña</label><input id="alPass" type="password" placeholder="mín. 6 caracteres">
      <div class="inline" style="justify-content:space-between">
        <button id="doLogin">Entrar</button>
        <button id="doGoogle" class="ghost">Entrar con Google</button>
        <button id="doReset" class="ghost">Olvidé mi contraseña</button>
        <button id="closeAuth" class="ghost">Cancelar</button>
      </div>
    </div>
    <div id="authReg" style="display:none">
      <label>Email</label><input id="arEmail" type="email">
      <label>Contraseña</label><input id="arPass" type="password">
      <div class="inline" style="justify-content:space-between">
        <button id="doRegister">Crear cuenta</button>
        <button id="closeAuth2" class="ghost">Cancelar</button>
      </div>
    </div>

    <div class="inline" style="justify-content:flex-end;margin-top:8px">
      <button id="doGuest" class="ghost" type="button">Usar sin cuenta (este dispositivo)</button>
    </div>

    <div class="small" id="authMsg"></div>
  </div>
</div>

<script>
/* ============ Firebase SAFE INIT ============ */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCrcpg531_Lzy6TBAfvei2Vbzcln99gUW0",
  authDomain: "ok-pagos-25803.firebaseapp.com",
  projectId: "ok-pagos-25803",
  storageBucket: "ok-pagos-25803.appspot.com",
  messagingSenderId: "704291450097",
  appId: "1:704291450097:web:f0ce42da229f0d1d30cd50",
  measurementId: "G-FKG9PR8VMH"
};
const CLOUD_ENABLED =
  !!(FIREBASE_CONFIG.apiKey) &&
  !/^TU_|^YOUR_/i.test(FIREBASE_CONFIG.apiKey);

let auth=null, db=null;

const saveModeEl = document.getElementById('saveMode');
const whoEl      = document.getElementById('who');
const btnAuth    = document.getElementById('btnAuth');
const btnLogout  = document.getElementById('btnLogout');
const authBk     = document.getElementById('authBk');
const authMsg    = document.getElementById('authMsg');

const alEmail = document.getElementById('alEmail');
const alPass  = document.getElementById('alPass');
const arEmail = document.getElementById('arEmail');
const arPass  = document.getElementById('arPass');

const doLogin    = document.getElementById('doLogin');
const doRegister = document.getElementById('doRegister');
const doGoogle   = document.getElementById('doGoogle');
const doGuest    = document.getElementById('doGuest');
const doReset    = document.getElementById('doReset');

const SKIP_LOGIN = 'ok_ev_skip_login';

function openAuth(){ authBk.style.display='flex'; }
function closeAuth(){ authBk.style.display='none'; authMsg.textContent=''; }

function mapAuthError(e){
  const code = e?.code || '';
  const M = {
    'auth/email-already-in-use': 'Ya existe una cuenta con este email. Iniciá sesión o restablecé la contraseña.',
    'auth/invalid-email':        'Email no válido.',
    'auth/user-not-found':       'No existe una cuenta con ese email.',
    'auth/wrong-password':       'Contraseña incorrecta.',
    'auth/too-many-requests':    'Demasiados intentos. Probá más tarde.'
  };
  return 'Firebase: ' + (M[code] || e.message || 'Error desconocido');
}

if (CLOUD_ENABLED) {
  firebase.initializeApp(FIREBASE_CONFIG);
  auth = firebase.auth();
  db   = firebase.firestore();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  btnAuth.onclick  = ()=>{ localStorage.removeItem(SKIP_LOGIN); openAuth(); };
  btnLogout.onclick= ()=> auth.signOut();

  document.getElementById('closeAuth').onclick = closeAuth;
  document.getElementById('closeAuth2').onclick = closeAuth;

  document.querySelectorAll('.auth-tabs .chip').forEach(ch=>{
    ch.onclick=()=>{
      const which=ch.dataset.auth;
      document.querySelectorAll('.auth-tabs .chip').forEach(x=>x.classList.toggle('active',x===ch));
      document.getElementById('authLogin').style.display=which==='login'?'block':'none';
      document.getElementById('authReg').style.display  =which==='register'?'block':'none';
      authMsg.textContent='';
    };
  });

  doLogin.onclick=async()=>{
    try{
      await auth.signInWithEmailAndPassword(alEmail.value.trim(), alPass.value);
      closeAuth();
    }catch(e){ authMsg.textContent = mapAuthError(e); }
  };

  doRegister.onclick=async()=>{
    try{
      await auth.createUserWithEmailAndPassword(arEmail.value.trim(), arPass.value);
      closeAuth();
    }catch(e){
      if(e.code === 'auth/email-already-in-use'){
        alEmail.value = arEmail.value.trim();
        document.querySelector('.auth-tabs .chip[data-auth="login"]').click();
        authMsg.textContent = 'Ya existe una cuenta con este email. Iniciá sesión o presioná "Olvidé mi contraseña".';
      }else{
        authMsg.textContent = mapAuthError(e);
      }
    }
  };

  doGoogle.onclick=async()=>{
    try{
      await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      closeAuth();
    }catch(e){ authMsg.textContent = mapAuthError(e); }
  };

  doReset.onclick = async ()=>{
    const email = (alEmail.value || arEmail.value || '').trim();
    if(!email){ authMsg.textContent = 'Escribí tu email arriba primero.'; return; }
    try{
      await auth.sendPasswordResetEmail(email);
      authMsg.textContent = 'Te enviamos un correo para restablecer tu contraseña.';
    }catch(e){ authMsg.textContent = mapAuthError(e); }
  };

  doGuest.onclick=()=>{ localStorage.setItem(SKIP_LOGIN,'1'); closeAuth(); };

  document.addEventListener('DOMContentLoaded', ()=>{
    if(!auth.currentUser && !localStorage.getItem(SKIP_LOGIN)) openAuth();
  });

} else {
  console.warn('Firebase desactivado → modo invitado (localStorage).');
  auth = {
    currentUser: null,
    onAuthStateChanged: (cb)=> cb(null),
    signOut: async()=>{}
  };
  db = null;
  saveModeEl.textContent = 'Modo invitado (local)';
  whoEl.textContent = '—';
  btnAuth.style.display = 'none';
  btnLogout.style.display = 'none';
  authBk.style.display = 'none';
  localStorage.setItem(SKIP_LOGIN,'1');
}

const isAuthed = ()=> !!(auth && auth.currentUser && auth.currentUser.uid);
const UCOL = (path)=> db.collection('users').doc(auth.currentUser.uid).collection(path);

/* ===== Utilidades ===== */
function num(v){
  if (typeof v === 'number' && isFinite(v)) return v;
  const s = (''+(v??'')).trim();
  if (!s) return 0;
  const hasComma = s.includes(',');
  const hasDot   = s.includes('.');
  if (hasComma && !hasDot){
    return parseFloat(s.replace(/\./g,'').replace(',', '.').replace(/[^\d.+-Ee]/g,'')) || 0;
  }
  if (hasDot && hasComma){
    return parseFloat(s.replace(/\./g,'').replace(',', '.').replace(/[^\d.+-Ee]/g,'')) || 0;
  }
  return parseFloat(s.replace(/,/g,'').replace(/[^\d.+-Ee]/g,'')) || 0;
}
const money = (n)=> '$ ' + Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
const isHttp = (u)=> u && /^https?:\/\//i.test(u);
const uid = ()=>'id_'+Math.random().toString(36).slice(2)+Date.now();
function normalizar(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }

/* ===== Storage local ===== */
const K = { EVENTS:'ok_ev_events', EXTRAS:'ok_ev_extras', MEDIA:'ok_ev_media', PAYSEQ:'ok_ev_payseq', LOGO:'ok_logo' };
const store = { get:(k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch{ return def; } }, set:(k,v)=> localStorage.setItem(k, JSON.stringify(v)) };

/* ===== Logo ===== */
const logoPreview = document.getElementById('logoPreview');
const logoFile = document.getElementById('logoFile');
const logoGuardar = document.getElementById('logoGuardar');
const logoStatus = document.getElementById('logoStatus');
(function(){ const saved=localStorage.getItem(K.LOGO); if(saved){ logoPreview.src=saved; logoStatus.textContent='Logo guardado'; }})();
logoFile.addEventListener('change', ()=>{
  if(!logoFile.files?.length) return;
  const f=logoFile.files[0];
  const r=new FileReader();
  r.onload=()=>{ logoPreview.src=r.result; logoStatus.textContent='Logo listo (sin guardar)'; };
  r.readAsDataURL(f);
});
logoGuardar.addEventListener('click', ()=>{ try{ localStorage.setItem(K.LOGO, logoPreview.src); logoStatus.textContent='Logo guardado'; }catch(e){ alert('No se pudo guardar el logo.'); }});

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('tab-'+t.dataset.tab).classList.add('active');
  };
});

/* ===== Semillas catálogo ===== */
const BASE_EXTRAS = [
  {type:'extra', name:"Chispas Frías X2", price:79000},
  {type:'extra', name:"Candy Bar / Candy Golosinas", price:79000},
  {type:'extra', name:"Decoración de Mesa Principal", price:90000},
  {type:'extra', name:"Decoración de Salón con Telas", price:95000},
  {type:'extra', name:"Sillón de Quinceañera", price:95000},
  {type:'extra', name:"Candy Glitter", price:95000},
  {type:'extra', name:"Decoración Tras Mesa Principal", price:95000},
  {type:'extra', name:"Túnel de Luces", price:100000},
  {type:'extra', name:"Letras Luminosas", price:105000},
  {type:'extra', name:"Living para 100 personas", price:120000},
  {type:'extra', name:"Pantalla y Proyector", price:135000},
  {type:'extra', name:"Barra Tropical con y sin Alcohol", price:145000},
  {type:'extra', name:"Altar Civil", price:145000},
  {type:'extra', name:"Centro de Mesas x 10U", price:150000},
  {type:'extra', name:"Cotillón para Fiestas", price:150000},
  {type:'extra', name:"Cámara 360", price:165000},
  {type:'extra', name:"Robot Led", price:225000},
  {type:'extra', name:"Cabina Fotográfica", price:225000},
  {type:'extra', name:"Fondo para Fotos", price:225000},
  {type:'extra', name:"Fuegos Artificiales", price:350000},
  {type:'extra', name:"Fotografía", price:354000},
  {type:'extra', name:"Video", price:354000},
];
const BASE_COMBOS = [
  {type:'combo', name:"EXTRAS COMBO – N°1", price:530000, desc:""},
  {type:'combo', name:"EXTRAS COMBO – N°1 (B)", price:390000, desc:""},
  {type:'combo', name:"EXTRAS COMBO – N°2", price:885000, desc:""},
  {type:'combo', name:"EXTRAS COMBO – N°2 (B)", price:750000, desc:""},
  {type:'combo', name:"EXTRAS COMBO – N°3", price:950000, desc:""},
];

/* ===== Estado ===== */
let extras = store.get(K.EXTRAS, []);
if(!extras.length){
  extras=[...BASE_EXTRAS, ...BASE_COMBOS].map(e=>({id:uid(), desc:(e.desc||""), ...e}));
  store.set(K.EXTRAS, extras);
}
let events = store.get(K.EVENTS, []);
let mediaMap = store.get(K.MEDIA, {});
let paySeqLocal = store.get(K.PAYSEQ, 0);
function nextSeqLocal(){ paySeqLocal++; store.set(K.PAYSEQ, paySeqLocal); return String(paySeqLocal).padStart(12,'0'); }

/* ===== Historial (Deshacer) ===== */
const historyStack = {};
function snapshot(ev){ return JSON.parse(JSON.stringify(ev)); }
function updateUndoButton(){
  const b = document.getElementById('pUndo');
  if(!currentEventId){ b.disabled = true; return; }
  const stack = historyStack[currentEventId] || [];
  b.disabled = stack.length === 0;
}

/* ===== AUTH listener ===== */
let unsubEvents=null, unsubExtras=null, unsubMedia=null;
if(auth && auth.onAuthStateChanged){
auth.onAuthStateChanged(async (user)=>{
  if(user){
    whoEl.textContent = user.email||user.uid;
    saveModeEl.textContent = 'Guardado en la cuenta (nube)';
    btnAuth.style.display='none'; btnLogout.style.display='inline-block';
    localStorage.removeItem(SKIP_LOGIN);

    if(unsubEvents) unsubEvents(); if(unsubExtras) unsubExtras(); if(unsubMedia) unsubMedia();

    unsubExtras = UCOL('extras').orderBy('name').onSnapshot(s=>{
      extras = []; s.forEach(d=> extras.push(d.data()));
      if(!extras.length){
        const batch = db.batch();
        [...BASE_EXTRAS, ...BASE_COMBOS].forEach(e=>{
          const id=uid(); batch.set(UCOL('extras').doc(id), {id, desc: (e.desc||""), ...e});
        });
        batch.commit();
      }
      store.set(K.EXTRAS, extras); fillCatalogSelects(); renderCatalog();
    });

    unsubEvents = UCOL('events').orderBy('date','desc').onSnapshot(s=>{
      events = []; s.forEach(d=> events.push(d.data()));
      store.set(K.EVENTS, events); renderEventList();
      if(currentEventId){
        const still = events.find(e=>e.id===currentEventId);
        if(still){ renderEventItems(); renderPayments(); refreshSummary(); fillEditPeople(still); updateUndoButton(); }
        else { evPanelBk.style.display='none'; currentEventId=null; updateUndoButton(); }
      }
    });

    unsubMedia = UCOL('media').onSnapshot(s=>{
      mediaMap={}; s.forEach(d=> mediaMap[d.id]=d.data().arr||[]);
      store.set(K.MEDIA, mediaMap);
    });

  }else{
    whoEl.textContent='—';
    saveModeEl.textContent='Modo invitado (local)';
    btnAuth.style.display='inline-block'; btnLogout.style.display='none';
    if(unsubEvents) unsubEvents(); if(unsubExtras) unsubExtras(); if(unsubMedia) unsubMedia();

    extras = store.get(K.EXTRAS, extras);
    events = store.get(K.EVENTS, events);
    mediaMap = store.get(K.MEDIA, mediaMap);

    if(CLOUD_ENABLED && !localStorage.getItem(SKIP_LOGIN)) openAuth();

    renderEventList(); fillCatalogSelects(); renderCatalog();
  }
});
}

/* ===== Refs (crear) ===== */
const evForm = document.getElementById('evForm');
const evType = document.getElementById('evType');
const evName = document.getElementById('evName');
const evDate = document.getElementById('evDate');
const errName = document.getElementById('errName');
const errDate = document.getElementById('errDate');
const errPrice = document.getElementById('errPrice');
const evPricePer = document.getElementById('evPricePer');
const evPricePerKids = document.getElementById('evPricePerKids');
const evProvince = document.getElementById('evProvince');
const evSalon = document.getElementById('evSalon');
const evSalonPrice = document.getElementById('evSalonPrice');
const evOption = document.getElementById('evOption');

const evAdultsDinner = document.getElementById('evAdultsDinner');
const evKidsDinner = document.getElementById('evKidsDinner');
const evAdultsAfter = document.getElementById('evAdultsAfter');
const evKidsAfter = document.getElementById('evKidsAfter');
const evPriceAfter = document.getElementById('evPriceAfter');
const evPriceAfterKids = document.getElementById('evPriceAfterKids');

const evBasePreview = document.getElementById('evBasePreview');

const newExFor = document.getElementById('newExFor');
const newExQty = document.getElementById('newExQty');
const newExPrice = document.getElementById('newExPrice');
const newAddEx = document.getElementById('newAddEx');
const newExList = document.getElementById('newExList');
const newExTotal = document.getElementById('newExTotal');
const newSumBase = document.getElementById('newSumBase');
const newSumExtras = document.getElementById('newSumExtras');
const newSumTotal = document.getElementById('newSumTotal');
const newClear = document.getElementById('newClear');
const searchNewEx = document.getElementById('searchNewEx');

const persName = document.getElementById('persName');
const persPrice = document.getElementById('persPrice');
const persQty = document.getElementById('persQty');
const addPersonal = document.getElementById('addPersonal');

const prevAdultsDinner = document.getElementById('prevAdultsDinner');
const prevKidsDinner = document.getElementById('prevKidsDinner');
const prevAdultsAfter = document.getElementById('prevAdultsAfter');
const prevKidsAfter = document.getElementById('prevKidsAfter');

/* ===== Refs (catálogo) ===== */
const exType = document.getElementById('exType');
const exName = document.getElementById('exName');
const exPrice = document.getElementById('exPrice');
const exDesc  = document.getElementById('exDesc');
const exCreate = document.getElementById('exCreate');
const exSelectFiles = document.getElementById('exSelectFiles');
const exList = document.getElementById('exList');
const exMedia = document.getElementById('exMedia');
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const btnUpload = document.getElementById('btnUpload');
const exLink = document.getElementById('exLink');
const btnAddLink = document.getElementById('btnAddLink');
const exSearch = document.getElementById('exSearch');

/* ===== Refs (lista) ===== */
const evSearch = document.getElementById('evSearch');
const evList = document.getElementById('evList');
const provChips = Array.from(document.querySelectorAll('.subtabs .chip'));
const typeChips = Array.from(document.querySelectorAll('.typefilters .chip'));

/* ===== Refs (panel) ===== */
const evPanelBk = document.getElementById('evPanelBk');
const pClose = document.getElementById('pClose');
const pDelete = document.getElementById('pDelete');
const pUndo   = document.getElementById('pUndo');
const pEvName = document.getElementById('pEvName');
const pEvMeta = document.getElementById('pEvMeta');

const exForEvent = document.getElementById('exForEvent');
const exQty = document.getElementById('exQty');
const exPriceOverride = document.getElementById('exPriceOverride');
const addExtraToEvent = document.getElementById('addExtraToEvent');

const persNameEv = document.getElementById('persNameEv');
const persPriceEv = document.getElementById('persPriceEv');
const persQtyEv = document.getElementById('persQtyEv');
const addPersonalEv = document.getElementById('addPersonalEv');

const evExtrasList = document.getElementById('evExtrasList');
const evExtrasTotal = document.getElementById('evExtrasTotal');
const evClearExtras = document.getElementById('evClearExtras');
const searchExEvent = document.getElementById('searchExEvent');

const payAmount = document.getElementById('payAmount');
const payMethod = document.getElementById('payMethod');
const payTarget = document.getElementById('payTarget');
const payPerson = document.getElementById('payPerson');
const payDate   = document.getElementById('payDate');
const payProof  = document.getElementById('payProof');

const paySave = document.getElementById('paySave');
const btnGeneralReceipt = document.getElementById('btnGeneralReceipt');
const payTotal = document.getElementById('payTotal');
const payList = document.getElementById('payList');

const newPricePer = document.getElementById('newPricePer');

const sumSalon = document.getElementById('sumSalon');
const sumSalonPrice = document.getElementById('sumSalonPrice');
const sumPricePer = document.getElementById('sumPricePer');
const sumBase = document.getElementById('sumBase');
const sumExtras = document.getElementById('sumExtras');
const sumTotal = document.getElementById('sumTotal');
const sumPaid = document.getElementById('sumPaid');
const sumRemain = document.getElementById('sumRemain');

const sumAdultsDinner = document.getElementById('sumAdultsDinner');
const sumKidsDinner = document.getElementById('sumKidsDinner');
const sumAdultsAfter = document.getElementById('sumAdultsAfter');
const sumKidsAfter = document.getElementById('sumKidsAfter');
const sumAfterPrices = document.getElementById('sumAfterPrices');
const sumExtrasInline = document.getElementById('sumExtrasInline');

const editSalon = document.getElementById('editSalon');
const editSalonPrice = document.getElementById('editSalonPrice');
const saveSalon = document.getElementById('saveSalon');

const edAdultsDinner = document.getElementById('edAdultsDinner');
const edKidsDinner = document.getElementById('edKidsDinner');
const edAdultsAfter = document.getElementById('edAdultsAfter');
const edKidsAfter = document.getElementById('edKidsAfter');
const edPriceAfter = document.getElementById('edPriceAfter');
const edPriceAfterKids = document.getElementById('edPriceAfterKids');
const savePeople = document.getElementById('savePeople');

let currentEventId = null;
let newEventItems = [];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  fillCatalogSelects(); renderCatalog(); renderEventList(); updateNewPreview();

  const newKidsLbl = document.getElementById('newKidsLbl');
  if (newKidsLbl) {
    const hasKidsPrice = num(evPricePerKids.value || 0) > 0;
    newKidsLbl.textContent = hasKidsPrice ? '' : ' (50%)';
  }

  ['input','change'].forEach(evt=>{
    [evAdultsDinner,evKidsDinner,evAdultsAfter,evKidsAfter,evPricePer,evPriceAfter,evPriceAfterKids,evPricePerKids,evSalonPrice]
      .forEach(el=> el.addEventListener(evt, updateNewPreview));
  });

  provChips.forEach(ch=>{
    ch.onclick=()=>{
      provChips.forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      renderEventList();
    };
  });

  typeChips.forEach(ch=>{
    ch.onclick=()=>{
      ch.classList.toggle('active');
      renderEventList();
    };
  });

  pUndo.addEventListener('click', undoLast);

  btnGeneralReceipt.addEventListener('click', ()=>{
    if(!currentEventId) return alert('Abrí un evento');
    generateGeneralReceipt(currentEventId);
  });

  if (searchNewEx) searchNewEx.addEventListener('input', ()=> fillCatalogSelects());
  if (searchExEvent) searchExEvent.addEventListener('input', ()=> fillCatalogSelects());
  if (exSearch) exSearch.addEventListener('input', renderCatalog);
});

/* ===== Helpers ===== */
function populateSelectFromExtras(sel, list, q=''){
  const query = normalizar(q);
  sel.innerHTML='';
  const g1=document.createElement('optgroup'); g1.label='Extras';
  const g2=document.createElement('optgroup'); g2.label='Combos';
  list
    .filter(it => !query || normalizar(it.name).includes(query))
    .forEach(it=>{
      const o=document.createElement('option');
      o.value=it.id; o.textContent=`${it.name} — ${money(it.price)}`;
      (it.type==='combo'?g2:g1).appendChild(o);
    });
  sel.appendChild(g1); sel.appendChild(g2);
}
function fillCatalogSelects(){
  populateSelectFromExtras(newExFor, extras, searchNewEx?.value||'');
  populateSelectFromExtras(exForEvent, extras, searchExEvent?.value||'');
  populateSelectFromExtras(exSelectFiles, extras, '');
}
function parseDateInput(v){
  v=(v||'').trim(); if(!v) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const m=v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){ const d=m[1].padStart(2,'0'), mo=m[2].padStart(2,'0'), y=m[3]; return `${y}-${mo}-${d}`; }
  return v;
}
function getActiveProvince(){ const a=document.querySelector('.subtabs .chip.active'); return a?.dataset.prov || 'Todos'; }
function getActiveTypes(){
  return Array.from(document.querySelectorAll('.typefilters .chip.active')).map(x=>x.dataset.type);
}

/* ===== Crear evento ===== */
evForm.addEventListener('submit', (e)=>{ e.preventDefault(); handleCreateEvent(); });
async function handleCreateEvent(){
  errName.textContent=errDate.textContent=errPrice.textContent='';
  const name=(evName.value||'').trim(); const date=parseDateInput(evDate.value);
  const pricePer=num(evPricePer.value);
  const pKc = Math.max(0, num(evPricePerKids.value||0));
  if(!name){ errName.textContent=' requerido'; return; }
  if(!date){ errDate.textContent=' requerido'; return; }
  if(pricePer<=0){ errPrice.textContent=' inválido'; return; }

  const ad= Math.max(0, num(evAdultsDinner.value));
  const kd= Math.max(0, num(evKidsDinner.value));
  const aa= Math.max(0, num(evAdultsAfter.value));
  const ka= Math.max(0, num(evKidsAfter.value));
  const pA = Math.max(0, num(evPriceAfter.value));
  const pK = Math.max(0, num(evPriceAfterKids.value));
  const salonPrice = Math.max(0, num(evSalonPrice.value||0));

  const id=uid();
  const payload={
    id,
    type:evType.value,
    name,
    date,
    province:evProvince.value||'San Juan',
    salon:(evSalon.value||'').trim()||null,
    salonPrice: salonPrice>0 ? salonPrice : 0,
    optionLabel:(evOption.value||'').trim()||null,
    pricePer:pricePer,
    pricePerKids: pKc>0 ? pKc : null,
    priceAfter:pA,
    priceAfterKids:pK,
    adultsDinner:ad,
    kidsDinner:kd,
    adultsAfter:aa,
    kidsAfter:ka,
    items:[...newEventItems.map(x=>({...x}))],
    payments:[],
    repriceLocks:[],
    createdAt:Date.now()
  };

  payload.baseTotal = baseOf(payload);

  if(isAuthed()){
    const ref = await UCOL('events').add(payload); await ref.update({id:ref.id});
  }else{
    events.unshift(payload); store.set(K.EVENTS, events);
  }

  // reset
  evType.value='15 años'; evName.value=''; evDate.value='';
  evProvince.value='San Juan'; evSalon.value=''; evOption.value='';
  evSalonPrice.value='';
  evPricePer.value=''; evPriceAfter.value=''; evPriceAfterKids.value='';
  evPricePerKids.value='';
  evAdultsDinner.value='100'; evKidsDinner.value='0'; evAdultsAfter.value='0'; evKidsAfter.value='0';
  newEventItems=[]; renderNewItems(); updateNewPreview(); renderEventList();
  alert('Evento creado ✅');
}

/* ===== Ítems NUEVO evento ===== */
newAddEx.addEventListener('click', ()=>{
  const id=newExFor.value; if(!id) return alert('Elegí un ítem');
  const base=extras.find(x=>x.id===id);
  const qty=Math.max(1,num(newExQty.value));
  const override=newExPrice.value===''?null:num(newExPrice.value);
  newEventItems.unshift({
    id:base.id,type:base.type,name:base.name,price:base.price,
    desc:(base.desc||""), overridePrice:override,qty
  });
  newExQty.value='1'; newExPrice.value=''; renderNewItems(); updateNewPreview();
});
newClear.addEventListener('click', ()=>{ newEventItems=[]; renderNewItems(); updateNewPreview(); });

// Extra personal NUEVO
addPersonal.addEventListener('click', ()=>{
  const n=(persName.value||'').trim();
  const p=num(persPrice.value);
  const q=Math.max(1,num(persQty.value));
  if(!n) return alert('Poné un nombre para el extra personal');
  if(p<=0) return alert('Precio inválido');
  newEventItems.unshift({ id:uid(), type:'personal', name:n, price:p, desc:'', overridePrice:null, qty:q });
  persName.value=''; persPrice.value=''; persQty.value='1';
  renderNewItems(); updateNewPreview();
});

function renderNewItems(){
  newExList.innerHTML=''; let total=0;
  newEventItems.forEach((e,idx)=>{
    const price=num(e.overridePrice ?? e.price);
    const sub=price*e.qty; total+=sub;
    const badge = e.type==='combo' ? 'Combo' : (e.type==='personal'?'Personal':'Extra');
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${e.name}</b> <span class="badge">${badge}</span>
      ${e.desc ? `<div class="small" style="max-width:520px;white-space:pre-wrap">${e.desc}</div>`:''}
      <div class="small">Precio: ${money(price)} — Cant: ${e.qty} — Subtotal: <b>${money(sub)}</b></div>
    </div>
    <button class="ghost" data-del="${idx}">Quitar</button>`;
    newExList.appendChild(div);
  });
  newExList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>{
    newEventItems.splice(Number(b.dataset.del),1); renderNewItems(); updateNewPreview();
  });
  newExTotal.textContent=money(total);
}

function updateNewPreview(){
  const tempEv={
    salonPrice: Math.max(0,num(evSalonPrice.value||0)),
    pricePerKids:num(evPricePerKids.value||0),
    pricePer:num(evPricePer.value),
    priceAfter:num(evPriceAfter.value),
    priceAfterKids:num(evPriceAfterKids.value),
    adultsDinner:Math.max(0,num(evAdultsDinner.value)),
    kidsDinner:Math.max(0,num(evKidsDinner.value)),
    adultsAfter:Math.max(0,num(evAdultsAfter.value)),
    kidsAfter:Math.max(0,num(evKidsAfter.value)),
    repriceLocks:[]
  };
  const base = baseOf(tempEv);
  let ex=0; newEventItems.forEach(e=>{ const price=num(e.overridePrice ?? e.price); ex+=price*num(e.qty); });
  prevAdultsDinner.textContent=tempEv.adultsDinner;
  prevKidsDinner.textContent=tempEv.kidsDinner;
  prevAdultsAfter.textContent=tempEv.adultsAfter;
  prevKidsAfter.textContent=tempEv.kidsAfter;
  newSumBase.textContent=money(base); newSumExtras.textContent=money(ex); newSumTotal.textContent=money(base+ex);
  evBasePreview.textContent='Total base estimado: '+money(base);
}

/* ===== Catálogo ===== */
function renderCatalog(){
  const q = normalizar(exSearch?.value||'');
  exList.innerHTML='';
  extras
    .filter(it => !q || normalizar(it.name).includes(q))
    .forEach(it=>{
      const row=document.createElement('div'); row.className='item';
      const badge=it.type==='combo'?'<span class="badge">Combo</span>':'<span class="badge">Extra</span>';
      row.innerHTML=`<div><b>${it.name}</b> ${badge}
         ${it.desc ? `<div class="small" style="max-width:620px;white-space:pre-wrap">${it.desc}</div>`:''}
         <div class="small">Precio catálogo: ${money(num(it.price))}</div>
         <div class="inline" style="margin-top:6px">
           <input type="text" class="name" value="${it.name}" data-id="${it.id}">
           <select class="kind" data-id="${it.id}">
             <option value="extra"${it.type!=='combo'?' selected':''}>Extra</option>
             <option value="combo"${it.type==='combo'?' selected':''}>Combo</option>
           </select>
           <input type="text" class="price" value="${num(it.price)}" data-id="${it.id}" inputmode="decimal">
         </div>
         <div class="inline">
           <textarea class="desc" data-id="${it.id}" placeholder="Descripción (opcional)">${it.desc||''}</textarea>
         </div>
         <div class="inline">
           <button class="ghost" data-save="${it.id}" type="button">Guardar</button>
           <button class="ghost" data-del="${it.id}" type="button">Eliminar</button>
           <button class="ghost" data-view="${it.id}" type="button">Galería</button>
         </div>
      </div>`;
      exList.appendChild(row);
    });
  exList.querySelectorAll('button[data-save]').forEach(b=>{
    b.onclick=async ()=>{
      const id=b.dataset.save;
      const name=exList.querySelector(`input.name[data-id="${id}"]`).value.trim();
      let price=num(exList.querySelector(`input.price[data-id="${id}"]`).value);
      const type=exList.querySelector(`select.kind[data-id="${id}"]`).value;
      const desc=exList.querySelector(`textarea.desc[data-id="${id}"]`).value||'';
      const idx=extras.findIndex(x=>x.id===id); extras[idx]={...extras[idx],name,price,type,desc};
      if(isAuthed()) await UCOL('extras').doc(id).set(extras[idx]);
      store.set(K.EXTRAS, extras); fillCatalogSelects(); renderCatalog();
    };
  });
  exList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=async ()=>{
    if(!confirm('Eliminar ítem?')) return;
    extras=extras.filter(x=>x.id!==b.dataset.del);
    if(isAuthed()) await UCOL('extras').doc(b.dataset.del).delete();
    store.set(K.EXTRAS, extras); fillCatalogSelects(); renderCatalog();
  });
  exList.querySelectorAll('button[data-view]').forEach(b=> b.onclick=()=> loadGallery(b.dataset.view));
}
exCreate.addEventListener('click', async ()=>{
  const name=(exName.value||'').trim(); if(!name) return alert('Nombre requerido');
  let price=num(exPrice.value||0); if(price<=0) return alert('Precio inválido');
  const id=uid(); const obj={id,type:exType.value,name,price,desc:(exDesc.value||'')};
  extras.unshift(obj); if(isAuthed()) await UCOL('extras').doc(id).set(obj);
  store.set(K.EXTRAS, extras);
  exName.value=''; exPrice.value=''; exDesc.value='';
  fillCatalogSelects(); renderCatalog();
});

/* Archivos ítem */
let selectedFiles=[];
function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
const okMediaSize = 900_000;
drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');selectedFiles=Array.from(e.dataTransfer.files||[]);alert(`${selectedFiles.length} archivo(s) listos`);});
fileInput.addEventListener('change',()=> selectedFiles = Array.from(fileInput.files||[]));
btnUpload.addEventListener('click', async ()=>{
  const id=exSelectFiles.value; if(!id) return alert('Elegí un ítem'); if(!selectedFiles.length) return alert('Seleccioná archivos');
  mediaMap[id]=mediaMap[id]||[];
  for(const f of selectedFiles){
    const dataUrl=await fileToDataUrl(f);
    if((dataUrl||'').length>okMediaSize){ alert(`"${f.name}" pesa mucho. Pegá un enlace en su lugar.`); continue; }
    mediaMap[id].unshift({name:f.name,type:f.type||'file',dataUrl,at:Date.now()});
  }
  selectedFiles=[]; fileInput.value='';
  if(isAuthed()) await UCOL('media').doc(id).set({arr:mediaMap[id]}); store.set(K.MEDIA, mediaMap);
  alert('Archivos guardados'); await loadGallery(id);
});
btnAddLink.addEventListener('click', async ()=>{
  const id=exSelectFiles.value; if(!id) return alert('Elegí un ítem');
  const link=(exLink.value||'').trim(); if(!isHttp(link)) return alert('Pegá un enlace válido');
  mediaMap[id]=mediaMap[id]||[]; mediaMap[id].unshift({name:link.split('/').pop(),type:'link',url:link,at:Date.now()});
  if(isAuthed()) await UCOL('media').doc(id).set({arr:mediaMap[id]}); store.set(K.MEDIA, mediaMap); exLink.value=''; await loadGallery(id);
});
async function loadGallery(id){
  exMedia.innerHTML=''; const arr=mediaMap[id]||[];
  if(!arr.length){ exMedia.innerHTML='<div class="small">Sin archivos</div>'; return; }
  arr.forEach(m=>{
    const box=document.createElement('div'); box.className='media';
    const pdf=(m.type||'').includes('pdf') || (m.url||'').toLowerCase().endsWith('.pdf') || (m.dataUrl||'').startsWith('data:application/pdf');
    const imgUrl=m.dataUrl||m.url;
    if(pdf){ box.innerHTML=`<div>PDF</div><a class="link" href="${imgUrl}" target="_blank">Abrir</a>`; }
    else if(imgUrl){ box.innerHTML=`<img src="${imgUrl}" alt=""><a class="link" href="${imgUrl}" target="_blank">Ver grande</a>`; }
    else{ box.innerHTML=`<div class="small">Archivo</div>`; }
    exMedia.appendChild(box);
  });
}

/* ===== Cálculos ===== */
function dinnerUnits(ev){
  const ad = Math.max(0, num(ev.adultsDinner||0));
  const kd = Math.max(0, num(ev.kidsDinner||0));
  const priceA = Math.max(0, num(ev.pricePer||0));
  const priceK = Math.max(0, num(ev.pricePerKids||0));
  const kidsFactor = priceA > 0 ? (priceK > 0 ? (priceK / priceA) : 0.5) : 0.5;
  return ad + kidsFactor * kd;
}
function round2(x){ return Math.round((x||0)*100)/100; }
function baseDinner(ev){
  const totalUnits = round2(dinnerUnits(ev));
  const locks = Array.isArray(ev.repriceLocks) ? ev.repriceLocks : [];
  let lockedUnits=0, lockedAmount=0;
  locks.forEach(l=>{
    const u = (typeof l.units === 'number') ? l.units : num(l.units);
    const p = (typeof l.price === 'number') ? l.price : num(l.price);
    lockedUnits += u; lockedAmount += u*p;
  });
  lockedUnits = round2(lockedUnits);
  const currentUnits = round2(Math.max(0, totalUnits - lockedUnits));
  return lockedAmount + currentUnits * Math.max(0,num(ev.pricePer||0));
}
function baseAfters(ev){
  const priceAfter = Math.max(0,num(ev.priceAfter||0));
  const priceAfterKids = Math.max(0,num(ev.priceAfterKids||0));
  const aa = Math.max(0,num(ev.adultsAfter||0));
  const ka = Math.max(0,num(ev.kidsAfter||0));
  return aa*priceAfter + ka*priceAfterKids;
}
function baseOf(ev){
  const salon = Math.max(0, num(ev.salonPrice||0));
  return baseDinner(ev) + baseAfters(ev) + salon;
}
function computeTotals(ev){
  const base = baseOf(ev);
  let extrasTotal=0; (ev.items||[]).forEach(it=> extrasTotal += num(it.overridePrice??it.price)*num(it.qty||1));
  let paid=0; (ev.payments||[]).forEach(p=> paid += num(p.amount));
  const total=base+extrasTotal; const remain=Math.max(0,total-paid);
  return {
    base, extrasTotal, total, paid, remain,
    salonPrice: Math.max(0, num(ev.salonPrice||0)),
    pricePer:num(ev.pricePer||0),
    priceAfter:num(ev.priceAfter||0),
    priceAfterKids:num(ev.priceAfterKids||0),
    ad:Math.max(0,num(ev.adultsDinner||0)),
    kd:Math.max(0,num(ev.kidsDinner||0)),
    aa:Math.max(0,num(ev.adultsAfter||0)),
    ka:Math.max(0,num(ev.kidsAfter||0))
  };
}

/* ===== Lista de eventos ===== */
function renderEventList(){
  const q=normalizar(evSearch?.value||'');
  const prov=getActiveProvince();
  const activeTypes=getActiveTypes();

  evList.innerHTML='';
  events
    .filter(e=> !q || normalizar(e.name||'').includes(q))
    .filter(e=> prov==='Todos'?true:((e.province||'San Juan')===prov))
    .filter(e=> activeTypes.length? activeTypes.includes(e.type||'') : true)
    .forEach(e=>{
      const t=computeTotals(e);
      const meta=`${e.type||'-'} • ${e.date||'sin fecha'} • ${e.province||'San Juan'}`;
      const salonTxt=e.salon?` • Salón: ${e.salon}`:'';
      const opt=e.optionLabel||'—';
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div>
          <b>${e.name||'-'}</b>
          <div class="small">${meta}${salonTxt}</div>
          <div class="small">Cena A:${t.ad} • N:${t.kd} | Después A:${t.aa} • N:${t.ka}</div>
        </div>
        <div class="inline">
          <span class="small">Opción: <b>${opt}</b></span>
          <span class="small">Precio cena: <b>${money(e.pricePer||0)}</b></span>
          <span class="small">Salón: <b>${money(t.salonPrice)}</b></span>
          <span class="small">Faltante: <b>${money(t.remain)}</b></span>
          <button class="ghost" data-open="${e.id}">Abrir</button>
          <button class="ghost" data-del="${e.id}">Eliminar</button>
        </div>`;
      evList.appendChild(div);
    });
  evList.querySelectorAll('button[data-open]').forEach(b=> b.onclick = ()=> openEventPanel(b.dataset.open));
  evList.querySelectorAll('button[data-del]').forEach(b=> b.onclick = ()=> deleteEventDeep(b.dataset.del));
}
evSearch.addEventListener('input', renderEventList);

/* ===== Panel evento ===== */
pClose.addEventListener('click', ()=> evPanelBk.style.display='none');
pDelete.addEventListener('click', ()=> currentEventId && deleteEventDeep(currentEventId));

function openEventPanel(id){
  currentEventId=id; const ev=events.find(x=>x.id===id)||{};
  pEvName.textContent=ev.name||'Evento';
  pEvMeta.textContent=`${ev.type||'-'} • ${ev.date||'sin fecha'} • ${ev.province||'San Juan'}`;
  editSalon.value=ev.salon||'';
  editSalonPrice.value = ev.salonPrice ? num(ev.salonPrice) : '';
  renderEventItems(); renderPayments(); refreshSummary(); fillEditPeople(ev); updateUndoButton();
  evPanelBk.style.display='flex';
  const kidsLbl = document.getElementById('kidsLbl');
  if (kidsLbl) {
    const hasKidsPrice = num(ev.pricePerKids || 0) > 0;
    kidsLbl.textContent = hasKidsPrice ? '' : ' (50%)';
  }
}

/* ===== Persistencia con historial ===== */
async function persistEvent(ev, push=true){
  if(push){
    const existing = events.find(x=>x.id===ev.id);
    if(existing){
      historyStack[ev.id] = historyStack[ev.id] || [];
      historyStack[ev.id].push(snapshot(existing));
      if(historyStack[ev.id].length>50) historyStack[ev.id].shift();
    }
  }
  if(isAuthed()) await UCOL('events').doc(ev.id).set(ev,{merge:true});
  else { const i=events.findIndex(x=>x.id===ev.id); if(i>-1) events[i]=ev; store.set(K.EVENTS, events); }
  if(ev.id===currentEventId) updateUndoButton();
}
async function undoLast(){
  const id=currentEventId; if(!id) return;
  const stack = historyStack[id]||[];
  if(!stack.length) { alert('No hay cambios para deshacer.'); return; }
  const prev = stack.pop();
  if(isAuthed()) await UCOL('events').doc(id).set(prev);
  const idx=events.findIndex(e=>e.id===id); if(idx>-1) events[idx]=prev; store.set(K.EVENTS, events);
  editSalon.value=prev.salon||'';
  editSalonPrice.value = prev.salonPrice ? num(prev.salonPrice) : '';
  renderEventItems(); renderPayments(); refreshSummary(); fillEditPeople(prev); updateUndoButton(); renderEventList();
}

/* ===== Eliminar evento (funciona abrir/eliminar) ===== */
async function deleteEventDeep(id){
  if(!id) return;
  const ev = events.find(e=>e.id===id);
  if(!ev) return;
  if(!confirm(`¿Eliminar el evento "${ev.name}"?`)) return;
  if(isAuthed()){
    try{ await UCOL('events').doc(id).delete(); }catch{}
  }
  events = events.filter(e=>e.id!==id);
  store.set(K.EVENTS, events);
  if(currentEventId===id){ evPanelBk.style.display='none'; currentEventId=null; }
  renderEventList();
}

/* ===== Salón ===== */
saveSalon.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  ev.salon=(editSalon.value||'').trim()||null;
  ev.salonPrice = Math.max(0, num(editSalonPrice.value||0))||0;
  ev.baseTotal = baseOf(ev);
  await persistEvent(ev);
  refreshSummary(); renderEventList();
  alert('Salón actualizado ✅');
});

/* ===== Editar personas & “después” ===== */
function fillEditPeople(ev){
  edAdultsDinner.value = ev.adultsDinner||0;
  edKidsDinner.value   = ev.kidsDinner||0;
  edAdultsAfter.value  = ev.adultsAfter||0;
  edKidsAfter.value    = ev.kidsAfter||0;
  edPriceAfter.value   = num(ev.priceAfter||0) || '';
  edPriceAfterKids.value = num(ev.priceAfterKids||0) || '';
}
savePeople.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  ev.adultsDinner = Math.max(0,num(edAdultsDinner.value));
  ev.kidsDinner   = Math.max(0,num(edKidsDinner.value));
  ev.adultsAfter  = Math.max(0,num(edAdultsAfter.value));
  ev.kidsAfter    = Math.max(0,num(edKidsAfter.value));
  ev.priceAfter   = Math.max(0,num(edPriceAfter.value));
  ev.priceAfterKids = Math.max(0,num(edPriceAfterKids.value));
  ev.baseTotal = baseOf(ev);
  await persistEvent(ev);
  refreshSummary(); renderEventList();
  alert('Cantidades y precios actualizados ✅');
});

/* ===== Extras en PANEL ===== */
addExtraToEvent.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  const id=exForEvent.value; if(!id) return alert('Elegí un ítem');
  const base=extras.find(x=>x.id===id); if(!base) return;
  const qty=Math.max(1,num(exQty.value));
  const override=exPriceOverride.value===''?null:num(exPriceOverride.value);
  ev.items = ev.items || [];
  ev.items.unshift({ id:base.id, type:base.type, name:base.name, price:base.price, desc:(base.desc||""), overridePrice:override, qty });
  await persistEvent(ev);
  exQty.value='1'; exPriceOverride.value='';
  renderEventItems(); refreshSummary();
});
addPersonalEv.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  const n=(persNameEv.value||'').trim(); const p=num(persPriceEv.value); const q=Math.max(1,num(persQtyEv.value));
  if(!n) return alert('Poné un nombre para el extra personal');
  if(p<=0) return alert('Precio inválido');
  ev.items = ev.items || [];
  ev.items.unshift({ id:uid(), type:'personal', name:n, price:p, desc:'', overridePrice:null, qty:q });
  await persistEvent(ev);
  persNameEv.value=''; persPriceEv.value=''; persQtyEv.value='1';
  renderEventItems(); refreshSummary();
});
evClearExtras.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  if(!confirm('¿Vaciar todos los ítems del evento?')) return;
  const ev=events.find(e=>e.id===currentEventId);
  ev.items=[];
  await persistEvent(ev);
  renderEventItems(); refreshSummary();
});
function renderEventItems(){
  if(!currentEventId){ evExtrasList.innerHTML=''; evExtrasTotal.textContent=money(0); return; }
  const ev=events.find(e=>e.id===currentEventId) || {items:[]};
  const items = ev.items||[];
  evExtrasList.innerHTML=''; let total=0;
  items.forEach((it,idx)=>{
    const price=num(it.overridePrice ?? it.price);
    const sub=price*num(it.qty||1); total+=sub;
    const badge = it.type==='combo' ? 'Combo' : (it.type==='personal'?'Personal':'Extra');
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<div><b>${it.name}</b> <span class="badge">${badge}</span>
      ${it.desc ? `<div class="small" style="max-width:520px;white-space:pre-wrap">${it.desc}</div>`:''}
      <div class="small">Precio: ${money(price)} — Cant: ${it.qty} — Subtotal: <b>${money(sub)}</b></div>
    </div>
    <button class="ghost" data-del="${idx}">Quitar</button>`;
    evExtrasList.appendChild(row);
  });
  evExtrasList.querySelectorAll('button[data-del]').forEach(b=> b.onclick=async ()=>{
    const idx = Number(b.dataset.del);
    const ev=events.find(e=>e.id===currentEventId);
    ev.items.splice(idx,1);
    await persistEvent(ev);
    renderEventItems(); refreshSummary();
  });
  evExtrasTotal.textContent=money(total);
}

/* ===== Reprecio (cena) ===== */
document.getElementById('btnReprice').addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  const newP = Math.max(0,num(newPricePer.value));
  if(newP<=0) return alert('Precio nuevo inválido');
  const unitsNow = round2(dinnerUnits(ev));
  ev.repriceLocks = ev.repriceLocks || [];
  ev.repriceLocks.push({ units: unitsNow, price: Math.max(0,num(ev.pricePer||0)), at: Date.now() });
  ev.pricePer = newP;
  ev.baseTotal = baseOf(ev);
  await persistEvent(ev);
  newPricePer.value='';
  refreshSummary(); renderEventList();
  alert('Reprecio aplicado ✅');
});

/* ===== Pagos ===== */
paySave.addEventListener('click', async ()=>{
  if(!currentEventId) return;
  const ev=events.find(e=>e.id===currentEventId);
  const amount = num(payAmount.value);
  if(amount<=0) return alert('Monto inválido');
  const dateStr = (payDate.value||'').trim();
  const when = dateStr ? new Date(dateStr+'T12:00:00').getTime() : Date.now();
  const method = (payMethod.value||'Otro');
  const target = (payTarget.value||'general');
  const person = (payPerson.value||'adulto');

  const f = payProof.files?.[0];
  if(!f){ alert('El comprobante es obligatorio.'); return; }
  const dataUrl = await fileToDataUrl(f);

  const payObj = {
    id: uid(),
    amount,
    method,
    target,
    person,
    at: when,
    proof: { name: f.name, type: f.type, dataUrl }
  };
  ev.payments = ev.payments || [];
  ev.payments.push(payObj);
  await persistEvent(ev);
  payAmount.value=''; payDate.value=''; payProof.value='';
  renderPayments(); refreshSummary();
  alert('Pago guardado ✅');
});
function renderPayments(){
  if(!currentEventId){ payList.innerHTML=''; payTotal.textContent=money(0); return; }
  const ev=events.find(e=>e.id===currentEventId) || {payments:[]};
  const pays=(ev.payments||[]).slice().sort((a,b)=>a.at-b.at);
  payList.innerHTML=''; let total=0;
  const destinoMap = { general:'General / Mixto', extras:'Extras', salon:'Salón', opciones:'Opciones (cena)', despues:'Después de cena' };
  pays.forEach((p,idx)=>{
    total += num(p.amount);
    const li=document.createElement('div'); li.className='item';
    const det = (p.target==='opciones'||p.target==='despues')
      ? `${destinoMap[p.target]} — ${(p.person==='nino'?'Niño':'Adulto')}`
      : (destinoMap[p.target] || 'General / Mixto');
    const proofLabel = p.proof?.name || 'Comprobante';
    const proofUrl = p.proof?.dataUrl || p.proof?.url || '';
    li.innerHTML = `
      <div>
        <b>${money(p.amount)}</b> • ${p.method||'-'} • ${new Date(p.at).toLocaleDateString('es-AR')}
        <div class="small">${det}</div>
        ${proofUrl ? `<a class="link" href="${proofUrl}" target="_blank">Ver ${proofLabel}</a>` : '<span class="small">Sin comprobante</span>'}
      </div>
      <button class="ghost" data-delpay="${idx}">Eliminar</button>
    `;
    payList.appendChild(li);
  });
  payList.querySelectorAll('button[data-delpay]').forEach(b=> b.onclick=async ()=>{
    const idx = Number(b.dataset.delpay);
    const ev=events.find(e=>e.id===currentEventId);
    ev.payments.splice(idx,1);
    await persistEvent(ev);
    renderPayments(); refreshSummary();
  });
  payTotal.textContent = money(total);
}

/* ===== Resumen ===== */
function refreshSummary(){
  if(!currentEventId){
    sumSalon.textContent='—'; sumSalonPrice.textContent=money(0);
    sumPricePer.textContent=money(0); sumBase.textContent=money(0);
    sumExtras.textContent=money(0); sumTotal.textContent=money(0);
    sumPaid.textContent=money(0); sumRemain.textContent=money(0);
    sumAdultsDinner.textContent='0'; sumKidsDinner.textContent='0';
    sumAdultsAfter.textContent='0'; sumKidsAfter.textContent='0';
    sumAfterPrices.textContent=`${money(0)} / ${money(0)}`;
    sumExtrasInline.textContent=money(0);
    return;
  }
  const ev=events.find(e=>e.id===currentEventId);
  const t=computeTotals(ev);
  sumSalon.textContent=ev.salon||'—';
  sumSalonPrice.textContent=money(t.salonPrice);
  sumPricePer.textContent=money(t.pricePer);
  sumBase.textContent=money(t.base);
  sumExtras.textContent=money(t.extrasTotal);
  sumTotal.textContent=money(t.total);
  sumPaid.textContent=money(t.paid);
  sumRemain.textContent=money(t.remain);
  sumAdultsDinner.textContent=t.ad;
  sumKidsDinner.textContent=t.kd;
  sumAdultsAfter.textContent=t.aa;
  sumKidsAfter.textContent=t.ka;
  sumAfterPrices.textContent=`${money(t.priceAfter)} / ${money(t.priceAfterKids)}`;
  sumExtrasInline.textContent=money(t.extrasTotal);
}

/* ==== Helpers comprobantes → imagen ==== */
function dataUrlToUint8Array(dataUrl){
  const base64 = (dataUrl.split(',')[1] || '');
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
  return bytes;
}
async function rasterizePdfFirstPage(dataUrl){
  if (!window.pdfjsLib) return null;
  try{
    const arr = dataUrlToUint8Array(dataUrl);
    const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
    const page = await pdf.getPage(1);
    const vp = page.getViewport({ scale: 2 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = vp.width; canvas.height = vp.height;
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
    return canvas.toDataURL('image/png');
  }catch{
    return null;
  }
}
async function proofToImageDataUrl(proof){
  if(!proof) return null;
  const src = proof.dataUrl || proof.url || '';
  if(!src) return null;
  if (/^data:application\/pdf/i.test(src) || /\.pdf(\?|$)/i.test(src)){
    return await rasterizePdfFirstPage(src);
  }
  if (/^data:image\//i.test(src)) return src;
  return null;
}
function loadImg(src){
  return new Promise((res,rej)=>{
    const i = new Image(); i.crossOrigin = 'anonymous';
    i.onload = ()=> res(i); i.onerror = rej; i.src = src;
  });
}

/* ==== Utilidades PDF ==== */
function ensureJsPDF(){
  if (!(window.jspdf && window.jspdf.jsPDF)) {
    alert('No se pudo cargar jsPDF.');
    return null;
  }
  return window.jspdf.jsPDF;
}
function savePdf(doc, filename){
  try { doc.save(filename); }
  catch (e) {
    const url = doc.output('bloburl');
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display='none';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }
}

/* ==== Recibo GENERAL (PDF) con links internos a comprobantes ==== */
async function generateGeneralReceipt(eventId){
  const jsPDF = ensureJsPDF(); if(!jsPDF) return;

  const ev = (events || []).find(e => e.id === eventId);
  if(!ev){ alert('Evento no encontrado'); return; }

  const t = computeTotals(ev);
  const pays = (ev.payments||[]).slice().sort((a,b)=>a.at-b.at);

  const seq = (typeof nextSeqAny === 'function')
    ? await nextSeqAny()
    : (typeof nextSeqLocal === 'function' ? nextSeqLocal() : String(Date.now()).slice(-12));

  const doc = new jsPDF({ unit:'mm', format:'a4' });

  const W=210, H=297, M=10, BOXW=W-2*M, PAD=6, X0=M, Y0=M, innerX=X0+PAD, innerW=BOXW-2*PAD;
  const moneyFmt = n => '$ ' + Number(n||0).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const destinoMap = { general:'General / Mixto', extras:'Extras', salon:'Salón', opciones:'Opciones (cena)', despues:'Después de cena' };
  let curPage = 1;

  doc.setLineWidth(0.25);
  doc.rect(X0, Y0, BOXW, H-2*M);

  try{
    const i=new Image(); i.crossOrigin='anonymous';
    i.src=document.getElementById('logoPreview').src;
    await new Promise(r=> i.onload=r);
    const c=document.createElement('canvas');
    c.width=i.width; c.height=i.height; c.getContext('2d').drawImage(i,0,0);
    doc.addImage(c.toDataURL('image/png'),'PNG', X0+BOXW-32, Y0+6, 24, 24);
  }catch{}

  doc.setFont('helvetica','bold'); doc.setFontSize(22);
  doc.text('RECIBO GENERAL', X0+PAD, Y0+16);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text('OK EVENTOS — CATERING Y EGRESADOS', X0+PAD, Y0+22);

  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  doc.text(`N° ${seq}`, X0+PAD, Y0+30);
  doc.setFont('helvetica','normal');
  doc.text(new Date().toLocaleString('es-AR'), X0+PAD+32, Y0+30);

  let y = Y0+36;
  const rowH=12, col1=innerX, col2=innerX+innerW/3, col3=innerX+innerW*2/3;
  const blockH = rowH*2;
  doc.rect(innerX, y, innerW, blockH);
  doc.line(col2, y, col2, y+blockH);
  doc.line(col3, y, col3, y+blockH);
  doc.line(innerX, y+rowH, innerX+innerW, y+rowH);

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('Nombre del evento', col1+2, y+5);
  doc.text('Fecha evento',      col2+2, y+5);
  doc.text('Provincia',         col3+2, y+5);
  doc.setFont('helvetica','bold');
  doc.text(ev.name||'—',        col1+2, y+10);
  doc.text(ev.date||'—',        col2+2, y+10);
  doc.text(ev.province||'—',    col3+2, y+10);

  doc.setFont('helvetica','normal');
  doc.text('Salón',             col1+2, y+rowH+5);
  doc.text('Opción/Plan',       col2+2, y+rowH+5);
  doc.text('Precio cena',       col3+2, y+rowH+5);
  doc.setFont('helvetica','bold');
  doc.text(ev.salon||'—',       col1+2, y+rowH+10);
  doc.text(ev.optionLabel||'—', col2+2, y+rowH+10);
  doc.text(moneyFmt(t.pricePer),col3+2, y+rowH+10);

  y += blockH + 6;

  if (t.salonPrice>0){
    doc.setFont('helvetica','bold'); doc.setFontSize(11);
    doc.text(`Precio de salón: ${moneyFmt(t.salonPrice)}`, innerX, y);
    y += 6;
  }

  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text('Pagos registrados', innerX, y); y += 6;

  const colW1 = 35, colW2 = 78, colW3 = 30, colW4 = 35;
  const tcol1 = innerX, tcol2 = tcol1 + colW1, tcol3 = tcol2 + colW2, tcol4 = tcol3 + colW3;
  const tableW = innerW, headerH = 10, rowGap = 8;

  doc.setLineWidth(0.25);
  doc.rect(innerX, y, tableW, headerH);
  doc.line(tcol2, y, tcol2, y+headerH);
  doc.line(tcol3, y, tcol3, y+headerH);
  doc.line(tcol4, y, tcol4, y+headerH);
  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  doc.text('Fecha',           tcol1+2, y+6);
  doc.text('Cliente/Destino', tcol2+2, y+6);
  doc.text('Método',          tcol3+2, y+6);
  doc.text('Monto',           tcol4+2, y+6);

  let curY = y + headerH;
  doc.setFont('helvetica','normal');
  let sumPaid = 0;
  const bottomSafe = H - M - 80;

  const rowLinkAreas = [];
  for (let i=0;i<pays.length;i++){
    const p = pays[i];
    sumPaid += Number(p.amount)||0;

    if (curY + rowGap > bottomSafe){
      doc.addPage(); curPage++;
      curY = Y0+12;
      doc.setFont('helvetica','bold'); doc.setFontSize(10);
      doc.rect(innerX, curY, tableW, headerH);
      doc.line(tcol2, curY, tcol2, curY+headerH);
      doc.line(tcol3, curY, tcol3, curY+headerH);
      doc.line(tcol4, curY, tcol4, curY+headerH);
      doc.text('Fecha', tcol1+2, curY+6);
      doc.text('Cliente/Destino', tcol2+2, curY+6);
      doc.text('Método', tcol3+2, curY+6);
      doc.text('Monto',  tcol4+2, curY+6);
      curY += headerH;
      doc.setFont('helvetica','normal');
    }

    const det = (p.target==='opciones'||p.target==='despues')
      ? `${destinoMap[p.target]||'General'} — ${(p.person==='nino'?'Niño':'Adulto')}`
      : (destinoMap[p.target]||'General / Mixto');

    doc.rect(innerX, curY, tableW, rowGap);
    doc.line(tcol2, curY, tcol2, curY+rowGap);
    doc.line(tcol3, curY, tcol3, curY+rowGap);
    doc.line(tcol4, curY, tcol4, curY+rowGap);

    doc.text(new Date(p.at).toLocaleDateString('es-AR'), tcol1+2, curY+6);
    doc.text(det, tcol2+2, curY+6);
    doc.text(p.method||'-', tcol3+2, curY+6);
    doc.text(moneyFmt(p.amount), tcol4 + colW4 - 2, curY+6, { align: 'right' });

    rowLinkAreas[i] = {
      page: curPage, x: tcol2+1.5, y: curY+1, w: colW2-3, h: rowGap-2
    };

    curY += rowGap;
  }

  curY += 8;
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text('Totales del evento', innerX, curY); curY += 4;

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.rect(innerX, curY, innerW, 24);
  doc.text(`Cena — Adultos: ${t.ad} • Niños: ${t.kd}`, innerX+2, curY+7);
  doc.text(`Después — Adultos: ${t.aa} • Niños: ${t.ka}`, innerX+innerW/2, curY+7);
  doc.text(`Extras: ${moneyFmt(t.extrasTotal)}`, innerX+2, curY+14);
  doc.text(`Precios después A/N: ${moneyFmt(t.priceAfter)} / ${moneyFmt(t.priceAfterKids)}`, innerX+innerW/2, curY+14);

  const remain = Math.max(0, t.total - sumPaid);
  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text(`TOTAL A PAGAR: ${moneyFmt(remain)}`, innerX, curY+32);

  /* === Comprobantes (cada uno ocupa una hoja completa) + anclas === */
  const proofAnchors = {};
  const proofs = [];
  for (let i=0;i<pays.length;i++){
    const p = pays[i];
    const imgUrl = await proofToImageDataUrl(p.proof||null);
    if (imgUrl) proofs.push({ payIndex:i, imgUrl, at:p.at });
  }

  if (proofs.length){
    for (let i=0;i<proofs.length;i++){
      const { imgUrl, at, payIndex } = proofs[i];
      doc.addPage(); curPage++;

      const maxW = BOXW;
      const maxH = H - 2*M;

      try{
        const img = await loadImg(imgUrl);
        const ratio = img.width / Math.max(1, img.height);
        let w = maxW, h = w / ratio;
        if (h > maxH) { h = maxH; w = h * ratio; }

        const x = X0 + (BOXW - w) / 2;
        const y = Y0 + (maxH - h) / 2;

        doc.addImage(imgUrl, 'PNG', x, y, w, h);

        // Pie con fecha (opcional)
        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        doc.text(new Date(at).toLocaleString('es-AR'), X0 + 2, H - M - 4);

        proofAnchors[payIndex] = { page: curPage, top: y };
      }catch{}
    }
  }

  // Links invisibles desde tabla de pagos al comprobante correspondiente
  for (let i=0;i<pays.length;i++){
    const area = rowLinkAreas[i];
    const anchor = proofAnchors[i];
    if (!area || !anchor) continue;
    doc.setPage(area.page);
    doc.link(area.x, area.y, area.w, area.h, {
      pageNumber: anchor.page,
      top: anchor.top
    });
  }

  const safe=(ev.name||'evento').replace(/[^\p{L}\p{N}_-]+/gu,'_');
  savePdf(doc, `Recibo_GENERAL_${safe}_${seq}.pdf`);
}
</script>
</body>
</html>
